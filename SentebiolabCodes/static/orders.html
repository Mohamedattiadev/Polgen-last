<!DOCTYPE html>
<html>
	<head>
		<!-- Standard Meta -->
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
		<link rel="shortcut icon" type="image/png" href="assets/images/fav.png"/>
		<!-- Site Properties -->
		<title>Orders</title>
		<link rel="stylesheet" type="text/css" href="semantic.min.css">
		<link rel="stylesheet" type="text/css" href="jquery-ui.css">
		<link rel="stylesheet" type="text/css" href="datatables/datatables.min.css">
		<link rel="stylesheet" type="text/css" href="css/general.css">
		
		<script src="jquery-3.3.1min.js"></script>
		<script src="jquery-ui.js"></script>
		<script src="jquery.cookie-1.4.1.js"></script>
		<script src="semantic.min.js"></script>
		<script src="datatables/datatables.min.js"></script>
	
		<script src="acm/acm-dataholder.js"></script>
		<script src="acm/acm-ui-auth.js" ></script>
		<script src="acm/acm-data-handler.js"></script>
		<script src="acm/acm-page-handler.js"></script>
		<script src="acm/acm-dialog.js"></script>
		<script src="acm/acm-table.js"></script>
		<script src="acm/acm-container.js"></script>
		<script src="acm/acm-img.js"></script>
		<script src="acm/acm-link.js"></script>
		<script src="acm/acm-dropdown.js"></script>
		<script src="acm/acm-input.js"></script>
		<script src="acm/acm-two-col-card.js"></script>
		<script src="./js/FileSaver.js"></script>
		
		<script src="./js/moment-with-locales.js"></script>
		
		<style>
			.content.container {
				margin-top:100px;
			}
			.tablecontent {
				cursor:pointer;
				color:#33E;
				text-decoration:underline;
			}
			.tablecontent:hover {
				text-decoration:none;
				text-shadow: 1px 1px 1px #555;
			}
			.ui.fullscreen.modal {
				position: static !important;
			}
		</style>
		
	</head>
	<body>
		<acmus id="navbarcontainer"></acmus>
		<acmus id="maincontainer"></acmus>
		<acmus id="dialogcontainer"></acmus>
		<acmus id="reportcontainer"></acmus>
	</body>
	<script>
		
	  // Helper
	var rangeBuilder = function (sr, sc, er, ec) {
		var val = 0, i = 0, indx = 0;
		// Excel columns start from 1 = A, 27 = AA ...
		var base = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		var start = '', end = '';

		val = sc;
		for (i = 0; Math.pow(base.length, i) - 1 < sc; i++) {
			indx = (val % base.length) - 1;
			val = Math.floor(val / base.length);
			start += base[indx];
		}
		val = ec;
		for (i = 0; Math.pow(base.length, i) - 1 < ec; i++) {
			indx = (val % base.length) - 1;
			val = Math.floor(val / base.length);
			end += base[indx];
		}
		return start + sr + ":" + end + er;
	};
	
	$(document).on("pagecreated", function(){
		
		$("#excelbutton").on("click", function (e) {

			var data = null;

			if ($($.getWidget("modaltable").element).transition("is visible")) {
				var table_data = $.getWidget('modaltable').getColsAOA([
					{ name: "name"},
					{ name: "primer_fifth.id"},
					{ name: "sequence"},
					{ name: "primer_third.id"},
					{ name: "null"},
					{ name: "primer_sca.id"},
					{ name: "primer_puri.id"},
				]);

				$.each(table_data,function(i,v) {
					v[4] = null;
				})
				
				console.log(table_data);
				
				var table_row_len = table_data.length;
				  //var table_col_len = table_data[0].length;
				  //var table_col_len = 6;

				  //var range = rangeBuilder(20, 1, 20 + table_row_len, table_col_len); // A20:XXX
				var range2 = rangeBuilder(21, 2, 20 + 231, 2);  // B21:BXX
				var range3 = rangeBuilder(21, 4, 20 + 231, 4);  // D21:DXX
				var range4 = rangeBuilder(21, 6, 20 + 231, 6);  // E21:EXX
				var range5 = rangeBuilder(21, 7, 20 + 231, 7);  // F21:FXX
				var imgrange = rangeBuilder(1,1,5,4);

				var data = {
					templateid : 1,
					sheets: [
					  {
						id: 1,
						'name': 'Siparis Talimatları',
						pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true },
						columns: [{ width: 36 }],
						properties: { defaultRowHeight: 16, showGridLines: false }
					  },
					  {
						id: 2,
						'name': 'Primer Sipariş Formu',
						image: true,
						imageRange: imgrange,
						cells: {
						  'B9': [
							[],
							['<date>'],
							['<name>'],
							['<curator>'],
							['<corporation>'],
							['<division>'],
							['<room>'],
							['<address>'],
							[],
							['<phone>'],
							['<email>']
						  ],
						  'F9': [
							[],
							['<order_no>'],
							[],
							['<vergi_dairesi ve no>'],
							[],
							['<billing_address>'],
							[],
							['<project_no>']
						  ],
						  'A21': table_data
						},
						validations: [
						  {
							target: [range2],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("fmodholder").key("val").join(",") +'"']
							}
						  },
						  {
							target: [range3],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("tmodholder").key("val").join(",") +'"']
							}
						  },
						  {
							target: [range4],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("scaholder").key("val").join(",") +'"']
							}
						  },
						  {
							target: [range5],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("puriholder").key("val").join(",") +'"']
							}
						  },
						]
					  }
					],
					
					excel_entries: {
						'<date>' : moment().format('YYYY-MM-DD HH:mm:ss')
					}
							
				};
				
			} else if ($($.getWidget("probetable").element).transition("is visible")) {
			
				var table_data = $.getWidget('probetable').getColsAOA([
					{ name: "name"},
					{ name: "probe_fifth.id"},
					{ name: "sequence"},
					{ name: "probe_third.id"},
				]);
				
				var table_row_len = table_data.length;
			
				var range2 = rangeBuilder(21, 2, 20 + 231, 2);  // B21:BXX
				var range3 = rangeBuilder(21, 4, 20 + 231, 4);  // D21:DXX
				var imgrange = rangeBuilder(1,1,5,4);
				
				var data = {
					templateid : 2,
					sheets: [
					  {
						id: 1,
						'name': 'Siparis Talimatları',
						pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true },
						columns: [{ width: 36 }],
						properties: { defaultRowHeight: 16, showGridLines: false }
					  },
					  {
						id: 2,
						'name': 'Prob Sipariş Formu',
						image: true,
						imageRange: imgrange,
						cells: {
						  'E1': [
							['Sentebiolab Biyoteknoloji'],
							['Cyberplaza C Blok No:1 B7 Bilkent'],
							['Çankaya ANKARA']
						  ],
						  'E5': [
							['Tel:', '+90-312-265-0662'],
							['Email:', 'order@sentebiolab.com.tr'],
							['Fax:', '+90-312-265-0663']
						  ],
						  'B9': [
							[],
							['<date>'],
							['<name>'],
							['<curator>'],
							['<corporation>'],
							['<division>'],
							['<room>'],
							['<address>'],
							[],
							['<phone>'],
							['<email>']
						  ],
						  'E9': [
							[],
							['<order_no>'],
							[],
							['<vergi_dairesi ve no>'],
							[],
							['<billing_address>'],
							[],
							['<project_no>']
						  ],
						  'A21': table_data
						},
						validations: [
						  {
							target: [range2],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("fmodholder2").key("val").join(",") +'"']
							}
						  },
						  {
							target: [range3],
							validation: {
							  type: 'list',
							  allowBlank: false,
							  formulae: ['"'+ $.getWidget("tmodholder2").key("val").join(",") +'"']
							}
						  },
						]
					  }
					],
					excel_entries: {
						//'<date>' : moment().format('YYYY-MM-DD HH:mm:ss')
					}
				};

			} else if ($($.getWidget("seqtable").element).transition("is visible")) {
			
				var table_data = $.getWidget('seqtable').getColsAOA([
					{ name: "name"},
					{ name: "cons"},
					{ name: "type"},
					{ name: "size"},
					{ name: "pname"},
					{ name: "pcons"},
					{ name: "pname"},
					{ name: "puri"},
				]);
				$.each(table_data, function (i, val) {
					if (table_data[i][6] === true) {
						table_data[i][6] = "✓ Yapılsın";
					} else {
						table_data[i][6] = "✘ Yapılmasın";
					}
				});
				var table_row_len = table_data.length;
			
			  var range2 = rangeBuilder(21, 3, 20 + 231, 3);  // B21:BXX
			  var range3 = rangeBuilder(21, 7, 20 + 231, 7);  // D21:DXX
			  var imgrange = rangeBuilder(1,1,5,4);

			  var data = {
				templateid : 5,
				sheets: [
				  {
					id: 1,
					'name': 'Siparis Talimatları',
					pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true },
					columns: [{ width: 36 }],
					properties: { defaultRowHeight: 16, showGridLines: false }
				  },
				  {
					id: 2,
					'name': 'Sekans Sipariş Formu',
					image: true,
					imageRange: imgrange,
					cells: {
					  'E1': [
						['Sentebiolab Biyoteknoloji'],
						['Cyberplaza C Blok No:1 B7 Bilkent'],
						['Çankaya ANKARA']
					  ],
					  'E5': [
						['Tel:', '+90-312-265-0662'],
						['Email:', 'order@sentebiolab.com.tr'],
						['Fax:', '+90-312-265-0663']
					  ],
					  'B9': [
						[],
						['<date>'],
						['<name>'],
						['<curator>'],
						['<corporation>'],
						['<division>'],
						['<room>'],
						['<address>'],
						[],
						['<phone>'],
						['<email>']
					  ],
					  'E9': [
						[],
						['<order_no>'],
						[],
						['<vergi_dairesi ve no>'],
						[],
						['<billing_address>'],
						[],
						['<project_no>']
					  ],
					  'A21': table_data
					},
					validations: [
					  {
						target: [range2],
						validation: {
						  type: 'list',
						  allowBlank: false,
						  formulae: ['"'+ "Sanger - PCR" + "," + "Sanger - Plazmit" + "," + "NextGen" + "," + "NextGen - Denovo" + "," +'"']
						}
					  },
					  {
						target: [range3],
						validation: {
						  type: 'list',
						  allowBlank: false,
						  formulae: ['"'+ "✓ Yapılsın" + "," + "✘ Yapılmasın" +'"']
						}
					  },
					]
				  }
				],
				excel_entries: {
					'<date>' : moment().format('YYYY-MM-DD HH:mm:ss')
				}
			  };

			}
			
			if (data != null){
			
				var dfilename = "sipariş_excel";
				if($.getWidget("ordercard").get()["ordernum"]) dfilename = $.getWidget("ordercard").get()["ordernum"];
			
				var datetemp = "Tarih Hata";
				if($.getWidget("ordercard").get()["date"]) datetemp = $.getWidget("ordercard").get()["date"];
			
				var userholder = $.getWidget("userholder").get();
				if (userholder && userholder.length > 0 && userholder[0] ) {
					data.excel_entries['<name>'] = userholder[0].name;
					data.excel_entries['<curator>'] = userholder[0].name;
					data.excel_entries['<address>'] = userholder[0].address;
					data.excel_entries['<corporation>'] = userholder[0].company;
					data.excel_entries['<division>'] = userholder[0].department;
					data.excel_entries['<room>'] = userholder[0].door;
					data.excel_entries['<phone>'] = userholder[0].phone;
					data.excel_entries['<email>'] = userholder[0].mail;
					data.excel_entries['<order_no>'] = dfilename;
					data.excel_entries['<date>'] = datetemp;
				}
			
				var xhr = new XMLHttpRequest();

				// Define what happens on successful data submission
				xhr.addEventListener('load', function (event) {
				  var blob = xhr.response;
				  saveAs(blob, dfilename + ".xlsx");
				});

				// Define what happens in case of error
				xhr.addEventListener('error', function (event) {
				  console.log('Oops! Something went wrong.');
				});

				// Set up our request
				xhr.open('POST', '/excel/export', true);
				xhr.setRequestHeader("Content-Type", "application/json");
				xhr.responseType = 'blob';

				xhr.send(JSON.stringify(data));
			}
		});
		
		$("#reportbutton").on("click", function (e) {

			if ($($.getWidget("modaltable").element).transition("is visible")) {
				
			} else if ($($.getWidget("probetable").element).transition("is visible")) {
			
				
			}
			
		});
		
	});
	
	</script>
<html>