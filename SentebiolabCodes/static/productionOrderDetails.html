<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="assets/images/fav.png"/>
  <!-- Site Properties -->
  <title>Üretim Sipariş Detaylar</title>


    <link rel="stylesheet" type="text/css" href="semantic.min.css">
		<link rel="stylesheet" type="text/css" href="jquery-ui.css">
		<link rel="stylesheet" type="text/css" href="datatables/datatables.min.css">
		
		<script src="jquery-3.3.1min.js"></script>
		<script src="jquery-ui.js"></script>
		<script src="jquery.cookie-1.4.1.js"></script>
		<script src="semantic.min.js"></script>
		<script src="datatables/datatables.min.js"></script>
	
		<script src="acm/acm-dataholder.js"></script>
		<script src="acm/acm-ui-auth.js" ></script>
		<script src="acm/acm-data-handler.js"></script>
		<script src="acm/acm-page-handler.js"></script>
		<script src="acm/acm-dialog.js"></script>
		<script src="acm/acm-table.js"></script>
		<script src="acm/acm-container.js"></script>
		<script src="acm/acm-img.js"></script>
		<script src="acm/acm-link.js"></script>
		<script src="acm/acm-dropdown.js"></script>
		<script src="acm/acm-input.js"></script>
		<script src="acm/acm-two-col-card.js"></script>
		<script src="acm/acm-xlsx.js"></script>
		<script src="acm/acm-file.js"></script>
		<script src="acm/acm-thumbnail.js"></script>
		<script src="acm/acm-modal.js"></script>
		<script src="acm/acm-prompt.js"></script>
		
		<script src="./js/moment-with-locales.js"></script>
		<script src="./datatables/datetime.js"></script>
		<script src="./datatables/widgetbase.js"></script>
		<script src="./js-xlsx/xlsx.full.min.js"></script>
		<script src="./js/FileSaver.js"></script>
		
		<style>
		.content.container {
			margin-top:100px;
		}
		.centertext {
			text-align: center;
		}
		.vertpad{
			padding-top: 1%;
			padding-bottom: 5%;
		}
		</style>

	</head>

	<body>
 
		<acmus id="navbarcontainer"></acmus>
		<acmus id="maincontainer"></acmus>
		<acmus id="dialogcontainer"></acmus>

	</body>

	<script>

	//dialogcontainer

	var getpriceprobe = function(probjson) {
		var pricearr = $.getWidget("priceholderprobe").query(
			{
				"fmodid" : probjson["probe_fifth"]["id"],
				"tmodid" : probjson["probe_third"]["id"]
			}
		)
		
		if(pricearr.length) {
			return pricearr[0]["val"];
		} else {
			return null;
		}

	}
	var getprice = function(primjson) {
	
		var purmolcost = 0;
		
		let purmol = $.getWidget("priceholder").query(
			{
				"puriid" : primjson["primer_puri"]["id"],
				"scaid" : primjson["primer_sca"]["id"]
			}
		)
		
		if(purmol.length) {
			purmolcost = purmol[0].val;
		}
		
		var modcost = 0;
		
		if(purmolcost) {
		
			if(primjson["primer_fifth"] != null && (primjson["primer_fifth"]["id"] != "0" || primjson["primer_fifth"]["id"] != "")) {
				let mod = $.getWidget("fmodholder").query({
					"id" : primjson["primer_fifth"]["id"]
				})
				if(mod.length) {
					modcost = mod[0].costval;
				}
			}
		
			if(primjson["primer_third"] != null && (primjson["primer_third"]["id"] != "0" || primjson["primer_third"]["id"] != "")) {
				let mod = $.getWidget("tmodholder").query({
					"id" : primjson["primer_third"]["id"]
				})
				if(mod.length) {
					modcost = mod[0].costval;
				}
			} 
			
		}
		var realbp =  primjson["sequence"].length;
		var Icount = countchar(primjson["sequence"],"I");
		
		if (Icount) modcost += (11.99 * Icount);
		
		realbp = realbp-Icount;
		
		var bp = 15;
		if (realbp > bp) bp = realbp;
		
		var totalcost = modcost + (bp * purmolcost);
		//console.log(totalcost);

		return totalcost;
	}

	var rangeBuilder = function (sr, sc, er, ec) {
		var val = 0, i = 0, indx = 0;
		// Excel columns start from 1 = A, 27 = AA ...
		var base = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
		var start = '', end = '';

		val = sc;
		for (i = 0; Math.pow(base.length, i) - 1 < sc; i++) {
			indx = (val % base.length) - 1;
			val = Math.floor(val / base.length);
			start += base[indx];
		}
		val = ec;
		for (i = 0; Math.pow(base.length, i) - 1 < ec; i++) {
			indx = (val % base.length) - 1;
			val = Math.floor(val / base.length);
			end += base[indx];
		}
		return start + sr + ":" + end + er;
	};
	
	$(document).on("pagecreated",function() {

		if ($.cookie("tempvar")) {
			var row = JSON.parse($.cookie("tempvar"));
			if(row.type == "primer") {
				$("#modaltable").transition("fade");
				$.getWidget("userholder").fetch('lazy',[row.userid]);
				$.getWidget("billholder").fetch('lazy',[row.id]);
				$.getWidget("priceholder").fetch('lazy',[row.userid]);
				$.getWidget("ordercard").fetch('lazy',[row.id]);
				$.getWidget("primercard").fetch('lazy',[row.id]);
				//$.getWidget("ordertotal").fetch('lazy',[row.id]);
				$.getWidget("primertable").fetch('eager',[row.id]);
			} else if(row.type == "probe") {
				$("#probetable").transition("fade");
				$.getWidget("userholder").fetch('lazy',[row.userid]);
				$.getWidget("billholder").fetch('lazy',[row.id]);
				$.getWidget("ordercard").fetch('lazy',[row.id]);
				$.getWidget("primercard").fetch('lazy',[row.id]);
				//$.getWidget("customercard").fetch('lazy',[row2]);
				$.getWidget("probetable").fetch('eager',[row.id]);
			} else if(row.type == "sequence") {
				$("#seqtable").transition("fade");
				$.getWidget("userholder").fetch('lazy',[row.userid]);
				$.getWidget("billholder").fetch('lazy',[row.id]);
				$.getWidget("ordercard").fetch('lazy',[row.id]);
				$.getWidget("primercard").fetch('lazy',[row.id]);
				//$.getWidget("customercard").fetch('eager',[row2]);
				$.getWidget("seqtable").fetch('eager',[row.id]);
			} else if(row.type == "gene") {
				$("#genetable").transition("fade");
				$.getWidget("userholder").fetch('lazy',[row.userid]);
				$.getWidget("billholder").fetch('lazy',[row.id]);
				$.getWidget("ordercard").fetch('lazy',[row.id]);
				$.getWidget("primercard").fetch('lazy',[row.id]);
				//$.getWidget("customercard").fetch('eager',[row2]);
				$.getWidget("genetable").fetch('eager',[row.id]);
			}
		} else {
			//window.location.href = "/productionOrderList.html";
			window.history.back();
		}

		$("#modifybtn").on("click", function (e) {
			var row = JSON.parse($.cookie("tempvar"));
			if(row.type == "primer") {
				console.log("primer");
				var arr = []; arr.push(row.id);
				$.getWidget('modal').show(arr,["probeedittable"]);
			} else if(row.type == "probe") {
				console.log("probe");
				var arr = []; arr.push(row.id);
				$.getWidget('modal').show(arr,["primeredittable"]);
			}
		});
		
		$("#cancelbtn").on("click", function (e) {
			var row = JSON.parse($.cookie("tempvar"));
			$.getWidget("prompt").fire("Silme uyarısı !","Silinecek siparişte " + row.productsnum + " adet ürün bulunmaktadır.\n Siparişi silmek istediğinizden emin misiniz ?", 
				function(){
					$.formAction({orderid: row.id , type: row.type},"deleteorderservice",function(resp){
						if(resp.ok == "ok") {
							//window.location.href = "/productionOrderList.html";
							window.history.back();
						} else {
							// TO DO  message error maybe
						}
					})
				}
			)
		});
		
		$("#approvebutton").on("click", function (e) {
		
			var editdata = null;
			var deleted = [];
			var ordertype = "primer";
		
			var probefail = false;
		
			if(row.type == "primer") {
				editdata = $.getWidget("primeredittable").get();
				ordertype = "primer";
				
				$.each(editdata, function(i,v){
					v["cost"] = getprice(v);
				});
				
				var seldata = $.getWidget("primeredittable").datatable.rows( { selected: true } ).data();
				$.each(seldata, function(i,v) {
					deleted.push(v.id)
				});
				
				console.log(editdata);
				
			} else if(row.type == "probe") {
				editdata = $.getWidget("probeedittable").get();
				ordertype = "probe";
				
					$.each(editdata, function(i,v){
						var temppp = getpriceprobe(v);
						if (temppp == null) probefail = true;
						v["cost"] = temppp;
					});
				
				var seldata = $.getWidget("probeedittable").datatable.rows( { selected: true } ).data();
				$.each(seldata, function(i,v) {
					deleted.push(v.id)
				});
				
			}
			
			console.log(editdata);
			
			if (probefail) {
				alert("Uygunsuz probe modifikasyon çifti girildi")
			} else {
				$.formAction({orderid: row.id, items: editdata , ordertype: ordertype, deleted: deleted},"editorderservice",function(resp){
					if (resp.ok == "ok") {
						location.reload();
					}
				});
			}
		});

		$("#excelbutton").on("click", function (e) { testwb()});

	
	});

		function countchar (str, ch){
		var c = 0;
		for (var i = 0; i < str.length; i++){
			if (str[i] == ch) c++;
		}
		return c;
	}/*
	raporlama = function (e) {
			if ($($.getWidget("primertable").element).transition("is visible")) {
				console.log("asd")
				var table_data = $.getWidget('primertable').getColsAOA([
					{ name: "name"},
					{ name: "sequence"}
				
				
				]);
				$("#tester").html(table_data[3][0]+" - "+table_data[3][1]);

			}


		}*/
testwb = function (e) {
	
	var data = null;

	if ($($.getWidget("primertable").element).transition("is visible")) {
		var table_data = $.getWidget('primertable').getColsAOA([
			{ name: "name"},
			{ name: "primer_fifth.id"},
			{ name: "sequence"},
			{ name: "primer_third.id"},
			{ name: "null"},
			{ name: "primer_sca.id"},
			{ name: "primer_puri.id"},
		]);

		$.each(table_data,function(i,v) {
			v[4] = null;
			if (v[6] == "DSLT") v[6] = "Standart(DSLT)";
			//v[5] = v[5] + " nmol";
		})	
		
		var table_row_len = table_data.length;

		var data = {
			templateid : 1,
			rows: table_data		
		};
		
	} else if ($($.getWidget("probetable").element).transition("is visible")) {
	
		var table_data = $.getWidget('probetable').getColsAOA([
			{ name: "name"},
			{ name: "probe_fifth.id"},
			{ name: "sequence"},
			{ name: "probe_third.id"},
		]);
		
		var table_row_len = table_data.length;
		
		var data = {
			templateid : 2,
			rows: table_data		
		};

	} else if ($($.getWidget("seqtable").element).transition("is visible")) {

		var table_data = $.getWidget('seqtable').getColsAOA([
			{ name: "name"},
			{ name: "cons"},
			{ name: "type"},
			{ name: "size"},
			{ name: "pname"},
			{ name: "pcons"},
			{ name: "pname"},
			{ name: "puri"},
		]);
		$.each(table_data, function (i, val) {
			if (table_data[i][6] === true) {
				table_data[i][6] = "Yapılsın";
			} else {
				table_data[i][6] = "Yapılmasın";
			}
		});
		var table_row_len = table_data.length;
	
		var data = {
			templateid : 5,
			rows: table_data		
		};
	}
	
	if (data != null){
	
		var dfilename = "sipariş_excel";
		console.log($.getWidget("ordercard").get());
		if($.getWidget("ordercard").get()["ordernum"])
			dfilename = $.getWidget("ordercard").get()["ordernum"];
	
		var datetemp = "Tarih Hata";
		if($.getWidget("ordercard").get()["date"]) datetemp = $.getWidget("ordercard").get()["date"];
	
		data.excel_entries = {};

		var userholder = $.getWidget("userholder").get();
		if (userholder && userholder.length > 0 && userholder[0] ) {
			data.excel_entries['<name>'] = userholder[0].name;
			data.excel_entries['<curator>'] = userholder[0].name;
			data.excel_entries['<address>'] = userholder[0].address;
			data.excel_entries['<corporation>'] = userholder[0].company;
			data.excel_entries['<division>'] = userholder[0].department;
			data.excel_entries['<room>'] = userholder[0].door;
			data.excel_entries['<phone>'] = userholder[0].phone;
			data.excel_entries['<email>'] = userholder[0].mail;
			data.excel_entries['<order_no>'] = dfilename;
			data.excel_entries['<date>'] = datetemp;
		}
	
		
		var billholder = $.getWidget("billholder").get();
		if (billholder && billholder.length > 0 && billholder[0] ) {
			if (billholder[0]["address"] != null && billholder[0]["address"] !== "") {
				data.excel_entries['<address>'] = billholder[0].address;
			}
			if (billholder[0]["bill"] != null && billholder[0]["bill"] !== "" && billholder[0]["taxnumber"] == null && billholder[0]["taxoffice"] == null && billholder[0]["project"] == null) {
				console.log("old format excel export !!!")
				try {
					var str = billholder[0]["bill"]
					var billaddr = str.split("Adres:")[1].split(",Vergis Dairesi:")[0];
					var billvergi = str.split("Adres:")[1].split(",Vergis Dairesi:")[1].split(",No:")[0];
					var billno = str.split("Adres:")[1].split(",Vergis Dairesi:")[1].split(",No:")[1].split(", Proje:")[0];
					var billproje = str.split("Adres:")[1].split(",Vergis Dairesi:")[1].split(",No:")[1].split(", Proje:")[1];
				
					data.excel_entries['<vergi_dairesi ve no>'] = billvergi + " - " + billno;
					data.excel_entries['<billing_address>'] = billaddr;
					data.excel_entries['<project_no>'] = billproje;
				} catch(err) {
					console.log(err)
				}
			} else {
				console.log("excel export !!!")
				var billaddr = billholder[0]["bill"] || ""
				var billvergi = billholder[0]["taxoffice"] || ""
				var billno = billholder[0]["taxnumber"] || ""
				var billproje = billholder[0]["project"] || ""

				data.excel_entries['<vergi_dairesi ve no>'] = billvergi + " - " + billno;
				data.excel_entries['<billing_address>'] = billaddr;
				data.excel_entries['<project_no>'] = billproje;
			}
		}

		var xhr = new XMLHttpRequest();

		// Define what happens on successful data submission
		xhr.addEventListener('load', function (event) {
		  var blob = xhr.response;
		  saveAs(blob, dfilename + ".xlsx");
		});

		// Define what happens in case of error
		xhr.addEventListener('error', function (event) {
		  console.log('Oops! Something went wrong.');
		});

		// Set up our request
		xhr.open('POST', '/excel/exportwb', true);
		xhr.setRequestHeader("Content-Type", "application/json");
		xhr.responseType = 'blob';

		xhr.send(JSON.stringify(data));
	}
}

	</script>
<html>