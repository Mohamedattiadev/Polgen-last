<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
  <!-- Site Properties -->
  <title>Üretim Sentez Raporu Probe</title>


  <link rel="stylesheet" type="text/css" href="semantic.min.css">
  <link rel="stylesheet" type="text/css" href="jquery-ui.css">
  <link rel="stylesheet" type="text/css" href="datatables/datatables.min.css">
  <link rel="stylesheet" type="text/css" href="css/prodreport.css">

  <script src="jquery-3.3.1min.js"></script>
  <script src="jquery-ui.js"></script>
  <script src="jquery.cookie-1.4.1.js"></script>
  <script src="semantic.min.js"></script>
  <script src="datatables/datatables.min.js"></script>

  <script src="acm/acm-ui-auth.js"></script>
  <script src="acm/acm-data-handler.js"></script>
  <script src="acm/acm-page-handler.js"></script>
  <script src="acm/acm-dialog.js"></script>
  <script src="acm/acm-table.js"></script>
  <script src="acm/acm-container.js"></script>
  <script src="acm/acm-img.js"></script>
  <script src="acm/acm-link.js"></script>
  <script src="acm/acm-dropdown.js"></script>
  <script src="acm/acm-input.js"></script>
  <script src="acm/acm-two-col-card.js"></script>
  <script src="acm/acm-xlsx.js"></script>
  <script src="acm/acm-file.js"></script>
  <script src="acm/acm-thumbnail.js"></script>
  <script src="acm/acm-modal.js"></script>
  <script src="acm/acm-cbox.js"></script>
  <script src="acm/acm-textarea.js"></script>
  <!--<script src="acm/acm-notifier.js"></script>-->
  <script src="acm/acm-dataholder.js"></script>
  <script src="acm/acm-prompt.js"></script>
  <script src="acm/acm-msgdiv.js"></script>

  <script src="./js/moment-with-locales.js"></script>
  <script src="./datatables/datetime.js"></script>
  <script src="./datatables/widgetbase.js"></script>
  <script src="./js-xlsx/xlsx.full.min.js"></script>
  <script src="./js/FileSaver.js"></script>

  <style>
    .content.container {
      margin-top: 100px;
    }
	
	tr td {
		padding-left: 0 !important;
		padding-right: 0 !important;
		text-align: center !important;
	}
	
	.inoalert {
		margin-left: 5%;
		padding-left: 5% !important;
		margin-right: 5%;
		padding-right: 5% !important;
		background-color: #cae7f1;
		margin-bottom: 25px;
		border-radius: 5px;
		color: #3f3f7d;
	}
	
	.inoalert div p {
		line-height: 5px;
	}
	
	.msgfloat {
		position: fixed;
		top: 20px;
		right: 20px;
		z-index: 1000;
	}
	
	textarea {
		resize: none;
		width: 100%;
		overflow-x: scroll;
		overflow-y: scroll;
		overflow-wrap: unset;
		white-space: pre;
	}
	
	.idtdata {
		margin-right : 30px;
		font-weight: bold !important;
	}
	
	table.dataTable tbody>tr.selected, table.dataTable tbody>tr>.selected {
		background-color: rgba(255, 146, 146, 0.5);
	}
	
	.repeated {
		background-color: rgba(255, 146, 146, 0.5);
	}
  </style>

</head>

<body>
  <acmus id="navbarcontainer"></acmus>
  <acmus id="maincontainer"></acmus>
  <acmus id="tablecontainer"></acmus>
  <acmus id="dialogcontainer"></acmus>
  <acmus id="repmodal"></acmus>
</body>

<script>

	$.fn.dataTable.ext.order['prodno'] = function  ( settings, col )
	{
		return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
			var x = td.innerHTML.split("-");
			return Number(x[x.length-1]);
			//return td.innerHTML;
		} );
	};

(function ($, DataTable) {
 
    if (!DataTable.ext.editorFields) {
        DataTable.ext.editorFields = {};
    }
 
    //var Editor = DataTable.Editor;
    var _fieldTypes = DataTable.ext.editorFields;
 
    // create new field type 'checkBox'
    _fieldTypes.checkBox = {
 
        // create element
        create: function (conf) {
 
            // enable element
            conf._enabled = true;
 
            // create checkbox element
            conf._input = $(
                '<input type="checkbox">'
            );
 
            return conf._input;
        },
 
        // get field value
        get: function (conf) {
             
            // return 'checked' value
            return conf._input[0].checked;
        },
 
        // set field value
        set: function (conf, val) {

            // check if data is 'Is Active'
            if (conf.data == 'dmt') // TODO need to change this <-------
            {
                // check the value
                if (val == true) {
                    // add attribute 'checked'
                    //conf._input[0].setAttribute('checked', true);
					conf._input[0].checked = true;
                } else {
					//conf._input[0].setAttribute('checked', false);
					conf._input[0].checked = false;
				}
            }
        },
		
		canReturnSubmit: function() {
			return true;
		}
    };
 
})(jQuery, jQuery.fn.dataTable);

  $(document).on("pagecreated", function () {

	$("#savebtn").on("click",function(){
	
		$.getWidget('reporttable').table.DataTable().rows().every(function (rowIdx, tableLoop, rowLoop) {
		
			var data = this.data();
			var a260 = data['a260'];
			
			if(a260 === null) {
				return;
			} else if (typeof(a260) == "string") {
				a260 = a260.replace(",",".");
				a260 = Number(a260);
				data['a260'] = a260;
			}
		});

		$.getWidget('reporttable').options.editor.localeditor = false;
		
		$.getWidget('reporttable').editor
		.edit($.getWidget("reporttable").datatable.rows().indexes(), false).submit(
			function () {
				console.log("saved vals")
			},
			function () {
				//display err
			}
		);
		
		
		//SAVE SNYTH DATA FOR STATS//

		var synthvals = {};
		
		if (synthvals.pcount = $.getWidget("reporttable").get().length == 0) return; 
		
		var oligos = $.getWidget("reporttable").get();
		
		synthvals.scale = 200;
		synthvals.pcount = oligos.length;
		
		synthvals.bp = 0;
		synthvals.dslt = {n: 0, aod: 0, anmol: 0};
		synthvals.opc = {n: 0, aod: 0, anmol: 0};
		synthvals.hplc = {n: 0, aod: 0, anmol: 0};
		
		synthvals.minod = null;
		synthvals.maxod = null;
		synthvals.minnmol = null;
		synthvals.maxnmol = null;
		
		synthvals.repeat = 0;
		
		$.each(oligos,function(oid){
			var val = oligos[oid];
			synthvals.bp += val.sequence.length;

			synthvals.hplc.n += 1;
			if(isNaN(val.od) === false) synthvals.dslt.aod += Number(val.od);
			if(isNaN(val.totalnmol) === false) synthvals.dslt.anmol += Number(val.totalnmol);
			if(synthvals.minod == null || synthvals.minod > val.od ) synthvals.minod = Number(val.od);
			if(synthvals.maxod == null || synthvals.maxod < val.od ) synthvals.maxod = Number(val.od);
			if(synthvals.minnmol == null || synthvals.minnmol > val.totalnmol ) synthvals.minnmol = Number(val.totalnmol);
			if(synthvals.maxnmol == null || synthvals.maxnmol < val.totalnmol ) synthvals.maxnmol = Number(val.totalnmol);
			
			if (isNaN(val.repeat) === false && val.repeat > 0)  synthvals.repeat += 1;			
			
		})

		if (synthvals.dslt.n > 0) {
			synthvals.dslt.aod /= synthvals.dslt.n;
			synthvals.dslt.anmol /= synthvals.dslt.n;
		}
		if (synthvals.opc.n > 0) {
			synthvals.opc.aod /= synthvals.opc.n;
			synthvals.opc.anmol /= synthvals.opc.n;
		}
		if (synthvals.hplc.n > 0) {
			synthvals.hplc.aod /= synthvals.hplc.n;
			synthvals.hplc.anmol /= synthvals.hplc.n;
		}
		
		var sid = JSON.parse($.cookie("report")).id;
		
		$.formAction({synthvals: synthvals,synthid: sid},"synthupdateservice",
			function(resp){
				if (resp.ok == "ok") {
					
				} else {
					//display err
				}
			}
		)
		
		
		
		
	});
  
    // Services ////////////////
	$("#copyseq").on("click",function(){
		var seq = $("#copyseq").attr("val");
		copyToClipboard(seq);
		$.getWidget("msg").show();
	});
	
	$("#modalbtncancel").on("click",function(){
		$.getWidget("mod").hide();
	});
	
	$("#allrepeat").on("click",function(){
		
		if ($.getWidget("reporttable").datatable.rows({selected:true})[0].length > 0) {

			var selectedRows = $.getWidget("reporttable").datatable.rows({selected:true}).data();
			var nonControl = [];
			$.each(selectedRows, function(i,v){
				if(v.orderid != null && v.orderid != 0) nonControl.push(v)
			});
			$.getWidget('modaltable').table.DataTable().rows().remove().draw();
			$.getWidget('modaltable').table.DataTable().rows.add(nonControl).draw();
			$.getWidget('repmodal').show();
		}
		
	});
	
	$("#repeatselected").on("click",function(){
		$.getWidget("prompt").fire("Oligo Tekrar Uyarısı","Seçili oligolar tekrar senteze alınmak üzere havuza geri yollansın mı ?",
			function() {
												
				var arr = $.getWidget("modaltable").datatable.rows().data().toArray();
				
				$.formAction({"items":arr,"type":"probe"},"repeatservice",function(resp){
					location.reload();
				})
				
			}
		)
	});
	
	$("#modalbtnset").on("click",function(){
					
		var row = $.getWidget("reporttable").getRowByDataId($("#modid").attr("val"));
		var data = row.data();
		
		var a260 = data['a260'];
        var sequence = data['sequence'];
		
		var elution = $.getWidget('elutionvolume').get();
        var pathlength = $.getWidget('pathlength').get();
		
		var od = ((a260 * (elution/1000)) / (pathlength/10)).toFixed(1);
		data['od'] = od;
		
		var excoef = 0;
		var mw = 0;
		
         var txt = $.getWidget("idt").get();
         // parse
         var lines = txt.trim().split("\n");
         var nextlinetemp = false;
         $.each(lines, function (n, elem) {
            if (elem.length){
               var tokens = elem.split(/\s+/);

               for (var i = 0; i < tokens.length; i++) {
                  if (tokens[i] == 'µg/OD260:') {
                     $('#inosineugod').text(tokens[i + 1] + ' µg/OD');
					 //ugod = Number(tokens[i + 1]);
                     break;
                  }
                  if (tokens[i] == 'nmole/OD260:') {
                     //console.log('nmolod: ' + tokens[i + 1]);
                     //self.lastinosine().nmolOD = tokens[i + 1];
                     $('#inosinenmolod').text(tokens[i + 1] + ' nmole/OD');
                     break;
                  }
                  if (tokens[i] == 'EXTINCTION' && tokens[i + 1] == 'COEFFICIENT') {
                     //console.log('ec: ' + tokens[i + 2]);
                     //self.lastinosine().EC = tokens[i + 2];
                     $('#inosineec').text(tokens[i + 2] + ' g/mole');
					 excoef = Number(tokens[i + 2]);
                     break;
                  }
                  if (tokens[i] == 'MOLECULAR' && tokens[i + 1] == 'WEIGHT') {
                     //console.log('mw: ' + tokens[i + 2]);
                     mw = Number(tokens[i + 2])
                     $('#inosinemw').text(tokens[i + 2] + ' g/mole');
                     break;
                  }
                  if (tokens[i] == 'MELT' && tokens[i + 1] == 'TEMP' && (tokens[i + 2] != 'RANGE')) {
                     //console.log('temp: ' + tokens[i + 2]);
                     //self.lastinosine().TmCBasic = Number(tokens[i + 2]).toFixed(0);
                     //self.lastinosine().TmC = '-';
                     //self.lastinosine().TmCSalt = '-';
                     $('#inosinemelttemp').text(tokens[i + 2] + ' C');
					 data["tmbasic"] = (Number(tokens[i + 2])).toFixed(1);
                     break;
                  }
                  if (tokens[i] == 'MIN' && tokens[i + 1] == 'MEAN' && tokens[i + 2] == 'MAX') {
                     nextlinetemp = true;
                     break;
                  }
                  if (nextlinetemp) {
                     nextlinetemp = false;
                     //console.log('temp: ' + tokens[i] + '-' + tokens[i + 2] + '-' + tokens[i + 4]);
                     $('#inosinemelttemp').text(tokens[i] + '-' + tokens[i+4] + ' C');
					 data["tmbasic"] = (Number(tokens[i + 2])).toFixed(1);
                     break;
                  }
                  if (tokens[i] == 'GC' && tokens[i + 1] == 'CONTENT') {
                     //console.log('gc: ' + tokens[i + 2]);
                     //self.lastinosine().GC = Number(tokens[i+2]).toFixed(0);
                     $('#inosinegc').text(tokens[i + 2] + ' GC');
                     break;
                  }
                  if (tokens[i] == 'LENGTH') {
                     //console.log('bp: ' + tokens[i + 1]);
                     $('#inosinebp').text(tokens[i + 1] + ' bp');
                     break;
                  }

               }
            }
         });
         
		if(data["probe_fifth"] != null) mw += Number(data["probe_fifth"]["mw"]);
		if(data["probe_third"] != null) mw += Number(data["probe_third"]["mw"]);
		 
		data["mw"] = mw.toFixed(1);
		 
		if(data["probe_fifth"] != null) excoef += Number(data["probe_fifth"]["e260"]);
		if(data["probe_third"] != null) excoef += Number(data["probe_third"]["e260"]);
		 
		 var nmol = (1000000/excoef);
		
		 var ugod = (nmol * data['mw'] / 1000);
		
		 data['totalng'] = (ugod * 1000 * od).toFixed(2);
		 data['conc'] = (data['totalng'] / elution).toFixed(2);
         data['totalnmol'] = (data['totalng'] / data['mw']).toFixed(2);
		 		 
		 row.data(data).draw();
		 
		 if (isrepeat(row)) row.select();
		else row.deselect();
		 
		$.getWidget('reporttable').editor.edit(row.index, false)
        .submit(
          function () {
            //console.log("BAŞARILI!");
          },
          function () {
            console.log("HATA MESAJI!");
          });
		//$.getWidget("mod").hide();
	})
	
	var rtonset = function(rt) {
		var inoalert = $("#inoalert");
		var inocont = $("#inocont");
		
		inoalert.html("<p>" + "DeoxyInosine bulunuyor!" + "</p>");
		
		var inocheck = false;
		
		rt.get().forEach(function (row) {
			if(row.sequence.includes("I")) {
				inocheck = true;
				inoalert.html(inoalert.html() + "<p>" + row.synthname + "</p>")
			}
		})
		
		if(inocheck) inocont.show();
		else inocont.hide();
	}
	
	$.getWidget("reporttable").options.onset = rtonset;
	
    var row = JSON.parse($.cookie("report"));
    $.getWidget("reporttable").fetch("lazy", [row.id]);
	$.getWidget("synthinfo").fetch("eager", [row.id]);

	
	var boxInfoService = {
      source: "ajax",
      url: "production"
    }
    $.Widget.registerService("boxInfoService",boxInfoService);

    ////////////////////////////
    // Preventing editor inline edit to send null values
    $.getWidget('reporttable').editor.on('open', function (e, type) {
      var cols = ["a260", "tmbasic", "mw", "conc", "totalng", "od", "totalnmol"];
	  var edi = this;
      cols.forEach( function (elm) {
        if( !edi.val(elm) ) edi.set(elm, "null");
      });
    });

    $('#bulkinsert').on('click', function (e) {
      $.getWidget('a260bulk').show();
    });

	$('#calculatebtn').on('click', function (e) {
	  // Calculate every row with new A260
	  
	  $.getWidget('reporttable').editor.submit();

	  var cint = 0;
	  
	  var elution = $.getWidget('elutionvolume').get();
	  var pathlength = $.getWidget('pathlength').get();
	  
      $.getWidget('reporttable').table.DataTable().rows().every(function (rowIdx, tableLoop, rowLoop) {

		var data = this.data();
				
		cint++
		
        // ... do something with data(), or this.node(), etc
        //console.log("A260:", this.node());
		var a260 = data['a260'];
				
		if(a260 === null) {
			this.select();
			return;
		} else if (typeof(a260) == "string") {
			a260 = a260.replace(",",".");
			a260 = Number(a260);
			data['a260'] = a260;
		}
		
        var sequence = data['sequence'];
        //var od = data['od'];

		//if (sequence.includes("I")) return;
		
		var od = ((a260 * (elution/1000)) / (pathlength/10)).toFixed(1);
		data['od'] = od;

		/*
        var _A = (sequence.match(/A/g) || []).length;
        var _G = (sequence.match(/G/g) || []).length;
        var _C = (sequence.match(/C/g) || []).length;
        var _T = (sequence.match(/T/g) || []).length;

        if (sequence.length < 14) {
          data['tmbasic'] = (2 * (_A + _T) + 4 * (_G + _C)).toFixed(1);
        } else if (sequence.length >= 14) {
          //data['tmbasic'] = (64.9 + 41 * (_G + _C - 16.4) / (_A + _T + _G + _C)).toFixed(1);
		  data['tmbasic'] = (64.9 + 41 * (sequence.calculateGc() * sequence.length - 16.4 ) / sequence.length ).toFixed(1);
        }
		//var mw = ((_A * 313.21) + (_T * 304.2) + (_C * 289.18) + (_G * 329.21) - 61.96);
		var mw = sequence.calculateMw();
		*/

		/*
		if(data["probe_fifth"] != null) mw += Number(data["probe_fifth"]["mw"]);
		if(data["probe_third"] != null) mw += Number(data["probe_third"]["mw"]);
		
		data['mw'] = mw.toFixed(2);
		
		var excoef = sequence.calculateEx();
		if(data["probe_fifth"] != null) excoef += Number(data["probe_fifth"]["e260"]);
		if(data["probe_third"] != null) excoef += Number(data["probe_third"]["e260"]);
		*/
		
		var excoef = Number(data["excoef"]);
		
		var nmol = (1000000/excoef);
		
		var ugod = (nmol * data['mw'] / 1000);
		
		data['totalng'] = (ugod * 1000 * od).toFixed(2);
		data['conc'] = (data['totalng'] / elution).toFixed(2);
        data['totalnmol'] = (data['totalng'] / data['mw']).toFixed(2);
		
		//this.data(data).draw()
		
		if(isrepeat(this)) this.select();
		else this.deselect();
		
      });

	   // Send to db or local edit !!!
	  $.getWidget('reporttable').editor
		.edit($.getWidget("reporttable").datatable.rows().indexes(), false).submit(
			function () {

			},
			function () {
				console.log("HATA MESAJI!");
			}
		);

    });

    $('#modalsend').on("click", function () {
      var modal_contents = $.getWidget("modaltextarea").get();
      var modal_content_list = modal_contents.match(/\S+/g);

      var row_length = $.getWidget('reporttable').table.DataTable().column(0).data().length;

	  var orderedrows = $.getWidget('reporttable').table.DataTable().rows({ order: 'applied' } )[0];
	  
	  $.each(modal_content_list, function(i,v){
		$.getWidget('reporttable').table.DataTable().cells(orderedrows[i], 'a260:name').every(function () {
			this.data(v);
		})
	  });

      $.getWidget('a260bulk').hide();
    });

    $('#exportbtn').on('click', function () {
      console.log("Export !");

      var table_dataunsorted = $.getWidget('reporttable').getColsAOA([
        { name: "order.ordernum" },
        { name: "sequence" },
        { name: "dmt" },
        { name: "synthname" },
        { name: "name" },
		{ name: "scale" },// 200
        { name: "primer_puri.id" },
        { name: "tmbasic" },
        { name: "gc" },        // (_G + _C) / sequence.length
        { name: "bp" },        // sequence.length
		{ name: "mw" },
        { name: "excoef" },    // 
        { name: "nmoleod" },   // totalnmol / od
        { name: "ugod" },      // totalng/(1000*od)
        { name: "conc" },
		{ name: "a260" },
        { name: "totalng" },
        { name: "od" },
        { name: "totalnmol" },
        { name: "stok100ulte" },  // 
        { name: "stok50ulte" },    // 
        // Other data for classifying the report
		
        { name: "orderid" },
        { name: "user.company" },
		
      ]);

		table_data=[];
	
		var order = $.getWidget('reporttable').table.DataTable().rows({ order: 'applied' } )[0];
		$.each(order,function(rit,rvt) {
			table_data.push( table_dataunsorted[rvt] );
		});

	  $.each(table_data,function(tdi,tdv){ // getColsAOA sets orderid to "" when orderid = 0 (controll primer-probe default orderid = 0). Set orderid back to 0 for controll primer-probe
		if(table_data[tdi][21] === "") table_data[tdi][21] = 0;
	  })
	  
      table_data.forEach(function (row) {
        var sequence = row[1];
		
		if (row[2] === true) row[2] = "ON";
		else if(row[2] === false) row[2] = "OFF" ;
		else if(row[2] === "") row[2] = "OFF" ;
		
        //var gc = ((sequence.match(/G/g) || []).length + (sequence.match(/C/g) || []).length) / (1.0 * sequence.length);
		var gc = row[8];
        var totalnmol = row[18];
        var od = row[17];
        var totalng = row[16];
		var mw = row[10];
        row[5] = 200;
		row[6] = "HPLC";
        row[8] = (gc*100).toFixed(2);
		row[9] = sequence.length;
		row[10] = (Number(row[10])).toFixed(2);
        row[11] = (Number(row[11])); // "excoefficient"
        row[12] = (totalnmol / od).toFixed(2);
        row[13] = (totalng / (1000 * od)).toFixed(2);
		row[14] = (Number(row[14])).toFixed(2);
		row[15] = (Number(row[15])).toFixed(2);
		row[16] = (Number(row[16])).toFixed(2);
		row[17] = (Number(row[17])).toFixed(2);
		row[18] = (Number(row[18])).toFixed(2);
        row[19] = (Number(totalng) / Number(mw) * 10 + 0.01).toFixed(1); //"stok 100 uL te";
        row[20] = (Number(row[19])*2).toFixed(1);
      });

      // Group by orderid
      var grouped_table_data = {};
      table_data.reduce(
        function (rv, cv) {
          if (!rv[cv[21]+"o"]) rv[cv[21]+"o"] = [];
          rv[cv[21]+"o"].push(cv);
          return rv;
        }, grouped_table_data);

      var reduced = [];
      table_data.reduce(function(rv, cv) {
        rv.push(cv.slice(0,20));
        return rv
      }, reduced);

      var data = {
        templateid: 3,
        sheets: [
          {
            id: 1,
            'name': 'Raporlar',
            views: [{zoomScale: 60}],
            cells: {
              'A2': reduced
            }
          }
          ,{
            id: 2,
            'name': 'template',
            cloned: true,
            views: [{zoomScale: 60}],
            imageRange: "B32:C32",
			remove: true,
          }
		]
      };

      var range1 = rangeBuilder(2, 1, 2, 6);
      var range2 = rangeBuilder(2, 7, 2, 14);
      var range3 = rangeBuilder(2, 15, 2, 20);
      var imgrange = rangeBuilder(1,1,1,3);
      var sheet_id = 3;
      for (var orderid in grouped_table_data) {
	  
        //var sheet = {};
        var company_name = grouped_table_data[orderid][0][22];
		var comp_ordernum = grouped_table_data[orderid][0][0];
        var synth_list = [];
        grouped_table_data[orderid].reduce(function(rv, cv) {
          rv.push(cv.slice(1, 21)); // Get requested columns to the report
          return rv;
        }, synth_list);

		var temp24s = [];

		if(synth_list.length > 24) {
			var ii,jj;
			for (ii=0,jj=synth_list.length; ii<jj; ii+=24) {
					temp24s.push(synth_list.slice(ii,ii+24));
			}
		} else temp24s.push(synth_list);

		for (var prod24 in temp24s) {

			var sheet = {};
			sheet["id"] = sheet_id;
			sheet["name"] = company_name + sheet_id;
			sheet["image"] = true;
			sheet["imageRange"] = imgrange;
			//sheet["merges"] = ["A1:T1"];
			sheet["cloneFrom"] = 2;
			sheet["views"] = [{zoomScale: 60}];
			sheet["cells"] = {
			'A2': [
				[
				"Baz Dizisi 5'-3'", "DMT ON/OFF", "SentezNo", "Ad", "Sentez Skalası (nmol)", "Saflaş. Türü", "Tm (°C)", "GC %",
				"bp", "MW (g/mol)", "Ex. Coef", "nmole/OD", "µg/OD", "Conc. (ng/µl)", "A260", "Total ng", "OD", "Total nmol", "100 µM stok - µl TE", "50 µM stok - µl TE"
				]
			],
			'A3': temp24s[prod24],
			'B31': [
				[comp_ordernum]
			]
			};

			data.sheets.push(sheet);
			++sheet_id;
			}

      }


      // Send data to export an Excel
      var xhr = new XMLHttpRequest();

	  var xlsxname = "synth.xlsx";
	  if ($.getWidget("synthinfo").get().data.length) xlsxname = $.getWidget("synthinfo").get().data[0].name + ".xlsx";
	  
      // Define what happens on successful data submission
      xhr.addEventListener('load', function (event) {
        var blob = xhr.response;
        saveAs(blob, xlsxname);
      });

      // Define what happens in case of error
      xhr.addEventListener('error', function (event) {
        console.log('Oops! Something went wrong.');
      });

      // Set up our request
      xhr.open('POST', '/excel/export', true);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.responseType = 'blob';

      xhr.send(JSON.stringify(data));

    });

    // Helper
    var rangeBuilder = function (sr, sc, er, ec) {
      var val = 0, i = 0, indx = 0;
      // Excel columns start from 1 = A, 27 = AA ...
      var base = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      var start = '', end = '';

      val = sc;
      for (i = 0; Math.pow(base.length, i) - 1 < sc; i++) {
        indx = (val % base.length) - 1;
        val = Math.floor(val / base.length);
        start += base[indx];
      }
      val = ec;
      for (i = 0; Math.pow(base.length, i) - 1 < ec; i++) {
        indx = (val % base.length) - 1;
        val = Math.floor(val / base.length);
        end += base[indx];
      }
      return start + sr + ":" + end + er;
    };

	$('#csvbtn').on("click", function () {
		
		if ($("#csvlink").length && $.getWidget("synthinfo").get().data.length) {
			
			var unorderedrows = $.getWidget('reporttable').getColsAOA([
				{ name: "sequence" },
				{ name: "dmt" },
				{ name: "synthname" },
				{ name: "name" },
				{ name: "order.ordernum" },
				{ name: "fmod" },
			]);
			var rows = [];
			var order = $.getWidget('reporttable').table.DataTable().rows({ order: 'applied' } )[0];
			$.each(order,function(rit,rvt) {
				rows.push( unorderedrows[rvt] );
			});
			
			if($.getWidget("csvi").get().length) {
				var tempi = $.getWidget("csvi").get();
				$.each(rows,function(ri,rv) {			
					rows[ri][0] = rows[ri][0].replaceAll("I", tempi);
				});
			}
			
			if($.getWidget("csvf").get().length) {			
				var tempf = $.getWidget("csvf").get();
				$.each(rows,function(ri,rv) {
					if(rows[ri][5] !== "" && rows[ri][5] != null) rows[ri][0] = tempf + rows[ri][0];
				});
			}
		
			$.each(rows,function(ri,rv) {	
					$.each(rows[ri],function(tri,trv){
						if ( rows[ri][tri].includes != undefined  && rows[ri][tri].includes('\n')) {
							rows[ri][tri] = rows[ri][tri].replaceAll('\r\n','');
						}
						rows[ri][5] = "";
						rows[ri][3] = rows[ri][3].replaceAll(',','');
					})
				
					if (rows[ri][1] === true ) rows[ri][1] = "DMTON";
					else rows[ri][1] = "DMTOFF";
				});

			var csvlink = $("#csvlink")[0];
			var csvContent = "";
			rows.forEach(function(rowArray){
			   var row = rowArray.join(",");
			   csvContent += row + "\r\n";
			});
			var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
			if (navigator.msSaveBlob) { // IE 10+
				navigator.msSaveBlob(blob, filename);
			} else {
				var link = document.createElement("a");
				if (link.download !== undefined) { // feature detection
					// Browsers that support HTML5 download attribute
					var url = URL.createObjectURL(blob);
					link.setAttribute("href", url);
					link.setAttribute("download", $.getWidget("synthinfo").get().data[0].name + ".csv");
					link.style.visibility = 'hidden';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
				}
			}
			
		} else {
			
		}
	});
	
	$('#synthcancel').on("click", function () {

		$.getWidget("prompt").fire("Sentez Silme Uyarısı","Sentezi silmek ve sentezdeki probları havuza göndermek istediğinizden emin misiniz ?",
			function() {

				$.getWidget('reporttable').options.editor.localeditor = false;

				contolprimerids = [];
				orderprimerids = [];
				
				var edi = $.getWidget("reporttable").editor;
				
				var orderids = [];
				
				$.getWidget("reporttable").datatable.rows().every(function(){
					if (this.data().orderid != null && this.data().orderid != 0) {
						orderprimerids.push(this.index());
						if (orderids.includes(this.data().orderid) === false) orderids.push(this.data().orderid);
					} else {
						contolprimerids.push(this.index());
					}
				});
							
				if(orderprimerids.length) {
					edi.edit(orderprimerids,false)
					.set("dmt","null")
					.set("synthid","null")
					.set("synthname","null")
					.set("od","null")
					.set("a260","null")
					.set("tmbasic","null")
					.set("mw","null")
					.set("conc","null")
					.set("totalng","null")
					.set("totalnmol","null")
					.set("excoef","null")
					.set("gc","null")
					.submit(function(){ // TO DO <--- breaks other values
						console.log("ok");
						
						$.formAction({orderids:orderids,type:"probe"},"orderProgressService",function(data){
							console.log("ok")
						})
						
						$(document).trigger("rowsdone");

					}, function() {
						console.log("not ok");
						window.location.reload();
					});
				} else {
					$(document).trigger("rowsdone");
				}
				
				if(contolprimerids.length) {
					edi.remove(contolprimerids,false).submit(function(x){
						console.log("ok");
						$(document).trigger("rowsdone");
					}, function() {
						console.log("not ok");
						window.location.reload();
					});
				} else {
					$(document).trigger("rowsdone");
				}
			}
		)
	});
		
	var checks = 0;
	$(document).on("rowsdone",function(){
		console.log("rowsdone");
		checks++;
		if (checks == 2) {
			$.formAction({id:row.id},"deletesynthservice",function(data){
				$.removeCookie("report");
				window.location.href = "productionOldSyntheses.html";
			});
		}
	});
		
	$("#reportexportbtn").on("click", function(){
		$.getFunction("print6")();
	});

  });

	String.prototype.replaceAll = function(search, replacement) {
		var target = this;
		return target.replace(new RegExp(search, 'g'), replacement);
	};
  
	var copyToClipboard = function(str) {
		var el = document.createElement('textarea'); 
		el.value = str;                            
		el.setAttribute('readonly', '');                
		el.style.position = 'absolute';                 
		el.style.left = '-9999px';                      
		document.body.appendChild(el);                  
		var selected = document.getSelection().rangeCount > 0 ? document.getSelection().getRangeAt(0) : false;                                 
		el.select();                                    
		document.execCommand('copy');                   
		document.body.removeChild(el);                  
		if (selected) {                                 
			document.getSelection().removeAllRanges();    
			document.getSelection().addRange(selected);  
		}
	};
	
	var checktable = {};
	checktable["1"] = {};
	checktable["2"] = {};
	checktable["3"] = {};
	checktable["1"]["1"] = 2;  checktable["1"]["2"] = 1; checktable["1"]["3"] = 1;
	checktable["2"]["1"] = 6;  checktable["2"]["2"] = 4; checktable["2"]["3"] = 4;
	checktable["3"]["1"] = 12; checktable["3"]["2"] = 8; checktable["3"]["3"] = 8;
	
	var isrepeat = function(row){
		var data = row.data()	
		var od = data.od;
		
		if(od == null || od == "null" || od == "") return false;
		
		if ( od < checktable["3"]["3"] ) return true;
		else return false;
	}

</script>
<html>