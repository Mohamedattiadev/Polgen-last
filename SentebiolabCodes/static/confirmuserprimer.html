<!DOCTYPE html>
<html>

<head>
	<!-- Standard Meta -->
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
	<!-- Site Properties -->
	<title>Kullanıcı Primer Siparişi</title>

	<link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
	<link rel="stylesheet" href="./semanticui/semantic.min.css">
	<link rel="stylesheet" href="./datatables/datatables.min.css">
	<link rel="stylesheet" type="text/css" href="css/orderpages.css">
	
	<script src="./jquery/jquery-3.3.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
	<script src="./semanticui/semantic.min.js"></script>
	<script src="./datatables/datatables.min.js"></script>

	<script src="acm/acm-ui-auth.js" ></script>
	<script src="acm/acm-data-handler.js"></script>
	<script src="acm/acm-page-handler.js"></script>
	<script src="acm/acm-dialog.js"></script>
	<script src="acm/acm-form.js"></script>
	<script src="acm/acm-input.js"></script>
	<script src="acm/acm-textarea.js"></script>
	<script src="acm/acm-table.js"></script>
	<script src="acm/acm-container.js"></script>
	<script src="acm/acm-img.js"></script>
	<script src="acm/acm-link.js"></script>
	<script src="acm/acm-dropdown.js"></script>
	<script src="acm/acm-cbox.js"></script>
	<script src="acm/acm-list.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-dataholder.js"></script>
	<script src="acm/acm-display.js"></script>
	<script src="acm/acm-prompt.js"></script>
	<script src="acm/acm-two-col-card.js"></script>
		
	<script src="./js/moment-with-locales.js"></script>
	<script src="./acm/acm-xlsx.js"></script>
	<!--<script src="./js-xlsx/shim.js"></script>-->
	<script src="./js-xlsx/xlsx.full.min.js"></script>
	<script src="./js/FileSaver.js"></script>
	
</head>
<body>
	<acmus id="navbarcontainer"></acmus>
	<acmus id="container"></acmus>
</body>
<script>
	
	var orderService = {
		source: "ajax",
		url: "orderPrimer"
	}
	
	$.Widget.registerService("orderService",orderService);
	
	var firstcreate = true;
	$(document).on("pagecreated",function() {
		if (firstcreate) {
			firstcreate = false;

			if($.cookie("adres") != null && $.cookie("adres") != undefined && $.cookie("adres") != "") {
				page.address = {
					type: "textarea",
					selector: "#address",
					options: {
						div: "ui left icon fluid input",
						textarea: "wsnormal",
						rows:3,
						max: 400
					}
				}
			}

			$.createWidgets(page);
			
			var tempuserid = $.cookie("primuserid");
			
			//ordercard //primercard //idholder
			$.getWidget("ordercard").fetch('lazy',[tempuserid]);
			$.getWidget("primercard").fetch('lazy',[tempuserid]);
			$.getWidget("address").fetch('lazy',[tempuserid]);
			$.getWidget("dropaddr").fetch('lazy',[tempuserid]);
			$.getWidget("addrholder").fetch('lazy',[tempuserid]);
			$.getWidget("idholder").fetch('lazy',[tempuserid]);
			$.getWidget("primertable").fetch('eager',[tempuserid]);
					
			
			var fatura = $.cookie("fatura");
			var adres = $.cookie("adres");
			var proje = $.cookie("proje");

			var daire = $.cookie("daire");
			var numara = $.cookie("numara");
		
			$.getWidget("billaddress").set(fatura);
			$.getWidget("address").set(adres);
			$.getWidget("project").set(proje);

			$.getWidget("taxoffice").set(daire);
			$.getWidget("taxnumber").set(numara);
		}
	});
	
	var addonchange = function(x) {
		
		var row = $.getWidget("addrholder").query({"id":x.get()});
		if (row.length) {
			$.getWidget("billaddress").set(row[0].address);
			$.getWidget("taxoffice").set(row[0].taxoffice);
			$.getWidget("taxnumber").set(row[0].taxnumber);
			$.getWidget("project").set(row[0].project);
		}
	}
	
	function order() { // TO DO
	
		if ($.cookie("primuserid")) {
	
			if ($.getWidget("datein").get().length) {

				var re = new RegExp(/([12]\d{3}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01]))/);
				if (re.test($.getWidget("datein").get())) {	
					$.formAction({
						primers : "primertable",
						address : "address",
						info : "info",
						bill:"billaddress",
						taxoffice:"taxoffice",
						taxnumber:"taxnumber",
						project:"project",
						userId: $.cookie("primuserid"),
						date: "datein"},"orderService",function(res){
						console.log(res);
						if (res.ok == "ok") {
							
							window.location.href = "/viewCustomerList.html";
						}
					});
				} else {
					alert("Tarih girişi formata uygun yapılmalı yada boş bırakılmalı !")
				}
				
			} else {
				$.formAction({
					primers : "primertable",
					address : "address",
					info : "info",
					bill:"billaddress",
					taxoffice:"taxoffice",
					taxnumber:"taxnumber",
					project:"project",
					userId: $.cookie("primuserid")},"orderService",function(res){
					console.log(res);
					if (res.ok == "ok") {
						window.location.href = "/viewCustomerList.html";
					}
				});
			}
		}
	}
	
	function cancel() {
		window.location.href = "/viewCustomerList.html";
	}
	
	var page = {
		container : {
			type: "container",
			selector: "#container",
			options: {
				div: "below_navbar ui container",
				structure: [
					{div:"ui segments",structure: [
						{div:"ui secondary segment",structure: [
							{h4:"ui header",html:"Primer Siparişinizi Onaylayın"}
						]},
						{div:"ui segment mainseg",structure: [
							{div:"ui stackable two column grid", structure:[
								{div:"column ui",structure: [
									{div:"ui segments",structure: [
										{div:"ui secondary segment",structure: [
											{p:"noclass",html:"Siparis bilgileri"}
										]},
										{div:"ui segment",structure: [
											{div: " #ordercard"}
										]}
									]}
								]},
								{div:"column ui",structure: [
									{div:"ui segments",structure: [
										{div:"ui secondary segment",structure: [
											{p:"noclass",html:"Siparis toplamı"}
										]},
										{div:"ui segment",structure: [
											{div: "#primercard"}
										]}
									]}
								]},
							]},
							{div:"vertpad ui input #datein"},
							{div:"vertpad #primertable"},
						]}
					]},
					{div:"ui secondary segment",structure: [
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Fatura adresi"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#billaddress"}
							]},
							{div: "two wide column",structure:[
								{div: "#dropaddr"}
							]}
						]},
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Vergi dairesi"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#taxoffice"}
							]}
						]},
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Vergi numarası"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#taxnumber"}
							]}
						]},
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Proje numarası"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#project"}
							]}
						]},
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Teslimat adresi"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#address"}
							]},
							{div: "two wide column",structure:[

							]}
						]},
						{div:"ui grid",structure:[
							{div: "three wide column",structure:[
								{h4:"ui header centertext",html:"Ek bilgiler"}
							]},
							{div: "eleven wide column",structure:[
								{div: "#info"}
							]},
							{div: "two wide column",structure:[

							]}
						]}	
					]},
					{div:"vertpad actions centertext", structure:[
						{div:"ui green button #orderbtn", attr: {"onclick" : "order();"}, structure: [
							{icon: "noclass", i:"ui check circle outline icon"},
							{span: "noclass",html:"Siparişi Onayla"}
						]},
						{div:"ui red button #cancelbtn", attr: {"onclick" : "cancel();"},structure: [
							{icon: "noclass", i:"ui times circle outline icon"},
							{span: "noclass",html:"İptal"}
						]}
					]},
					{div: "#addrholder"},
					{div: "#idholder"},
				]
			}
		},
		primertable: {
			type: "table",
			selector: "#primertable",
			options: {
				oncreate: false,
				datasource:"editorService",
				fetchparams:{
					table: "primer_temporary",
					columns: ["name", "sequence", "fmod", "tmod", "purification", "scale","cost"],
					join: [
						{table:"primer_puri", foreign:"purification", datakey:"primer_puri.id"},
						{table:"primer_sca", foreign:"scale", datakey:"primer_sca.id"},
						{table:"primer_fifth", foreign:"fmod", datakey:"primer_fifth.id"},
						{table:"primer_third", foreign:"tmod", datakey:"primer_third.id"}
					],
					whereparams: ["userid"],
					filter: {
						where : {
							orderitem: true
						}
					}
				},
				table: "ui celled table",
				datatable: {
					responsive: true,
					dom: '<"top">rt<"bottom"p><"clear">',
					paging: false,
					columns: [
						{ title: "#", data: null, render: "itemno" },
						{ name: "name", data: "name", title: "İsim"},
						{ name: "sequence", data: "sequence", title: "Sekans" 
							,"render": "ellipsis3"//$.fn.dataTable.render.ellipsis(10,3)
						},
						{ title: "bp", data: null, render: "getbp" },
						{ name: "fmod", data: "primer_fifth.val", title: "5'" 
							,"render": function (data) {if (data == null) return " - "; else return data; }
						},
						{ name: "tmod", data: "primer_third.val", title: "3'" 
							,"render": function (data) {if (data == null) return " - "; else return data; }
						},
						{ name: "purification", data: "primer_puri.val", title: "Purification"},
						{ name: "scale", data: "primer_sca.val", title: "Skala" },
						{ name: "cost", data: "cost", title: "Cost" 
							,"render": function (data) {return data + " €";}
						},
					]
				}
			}
		},
		datein : {
			type: "input",
			selector: "#datein",
			options:{
				div: "mini ui left labeled input", //div: "mini ui left labeled action input",
				type: "text",
				placeholder: "YYYY-AA-GG",
				label: {html: "Tarih :",label: "ui label"},
				//width: "65px"
			}
		},
		ordercard: {
			type: "twocolcard",
			selector: "#ordercard",
			options: {
				oncreate: false,
				datasource:"tableService",
				fetchparams:{

					table: "orders",
					columns: ["ordernum","type", "date", "approval", "totalcost"],
					filter: {
						where : {
							orderdone: false
						}
					},
					whereparams: ["userid"],


				},
				div: "ui fluid card",
				structure:[
					{div:"content", structure:[
						{div:"header", html:"Sipariş Bilgileri"}
					]},
					{div:"content", structure:[
						{table:"ui very basic table"}
					]},
				],
				fields: [
					{name:"ordernum", html:"Sipariş No:", def:'orderno'},
					{name:"type", html:"Ürün Türü", def:'<i class="dna icon"></i> Primer'},
					{name:"date", html:"Sipariş Tarihi", render:"momentdate"},
					{name:"approval", html:"Onay Durumu", def: '<i class="hourglass half icon"></i> Onay Bekliyor.'},
					{name:"mail", html:"E-posta"},
					{name:"totalcost", html:"Tutar €"}
				]
			}
		},
		primercard: {
			type: "twocolcard",
			selector: "#primercard",
			options: {
				oncreate: false,
				datasource: "extraservice",
				fetchparams: {
					extra: "puricount",
					confirm: true,
					whereparams: ["userid"],
				},
				div: "ui fluid card",
				structure:[
					{div:"content", structure:[
						{div:"header", html:"Sipariş Bilgileri"}
					]},
					{div:"content", structure:[
						{table:"ui very basic table"}
					]},
				],
				fields: [
					{name:"totalbp", html:"Toplam BP"},
					{name:"productsnum", html:"Adet"},
					{ name: "1", html: "DSLT", def: "-" },
					{ name: "2", html: "OPC", def: "-" },
					{ name: "3", html: "HPLC", def: "-" }
				]
			}
		},
		billaddress: {
			type: "textarea",
			selector: "#billaddress",
			options: {
				div: "ui left icon fluid input",
				textarea: "wsnormal",
				rows:3,
				max: 400
			}
		},
		taxoffice: {
			type: "textarea",
			selector: "#taxoffice",
			options: {
				div: "ui left icon fluid input",
				textarea: "wsnormal",
				rows:3,
				max: 100
			}
		},
		taxnumber: {
			type: "textarea",
			selector: "#taxnumber",
			options: {
				div: "ui left icon fluid input",
				textarea: "wsnormal",
				rows:3,
				max: 50
			}
		},
		project: {
			type: "textarea",
			selector: "#project",
			options: {
				div: "ui left icon fluid input",
				textarea: "wsnormal",
				rows:3,
				max: 50
			}
		},
		address: {
			type: "textarea",
			selector: "#address",
			options: {
				div: "ui left icon fluid input",
				oncreate: false,
				datasource:"tableService",
				fetchparams:{
					table: "users",
					columns: ["address"],
					whereparams: ["userid"],
				},
				textarea: "wsnormal",
				rows:3,
				max: 400
			}
		},
		info: {
			type: "textarea",
			selector: "#info",
			options: {
				div: "ui left icon fluid input",
				textarea: "wsnormal",
				rows:3,
				max: 200
			}
		},
		dropaddr : {
			type: "ddown",
			selector: "#dropaddr",
			options: {
				name : "dropaddr",
				onchange : addonchange,
				dataformat: {
					val: "address"
				},
				oncreate: false,
				datasource:"tableService",
				fetchparams:{
					table: "billingaddress",
					columns: ["id","address"],
					whereparams: ["userid"],
				},
				div: "ui labeled selection fluid dropdown icon",
				header: [
					{span:"text"},
					{icon: "dropdown icon"}
				],
				semanticOptions : {
					showOnFocus : false
				}
			}
		},
		addrholder: {
			type: "dataholder",
			selector: "#addrholder",
			options: {
				oncreate: false,
				datasource:"tableService",
				fetchparams:{
					table: "billingaddress",
					columns: ["id","taxoffice","taxnumber","address","project"],
					whereparams: ["userid"],
				},
				div: "hidden"
			}
		},
		idholder: {
			type: "dataholder",
			selector: "#idholder",
			options: {
				oncreate: false,
				datasource:"tableService",
				fetchparams:{
					table: "orders",
					columns: ["id"],
					filter: {
						where : {
							orderdone: false
						}
					},
					whereparams: ["userid"],
				},
				div: "hidden"
			}
		},
	}

</script>
<html>