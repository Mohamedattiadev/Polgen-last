<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
  <!-- Site Properties -->
  <title>Admin Order Details</title>

  <link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
  <link rel="stylesheet" href="./semanticui/semantic.min.css">
  <link rel="stylesheet" href="./datatables/datatables.min.css">
	<link rel="stylesheet" href="./css/general.css">
   
  <script src="./jquery/jquery-3.3.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
	<script src="./semanticui/semantic.min.js"></script>
	<script src="./datatables/datatables.min.js"></script>

	<script src="./js/moment-with-locales.js"></script>
	<script src="./datatables/datetime.js"></script>
	<script src="./datatables/widgetbase.js"></script>

	<script src="./js-xlsx/xlsx.full.min.js"></script>
	<script src="./js/FileSaver.js"></script>

	<script src="acm/acm-ui-auth.js"></script>
	<script src="acm/acm-data-handler.js"></script>
	<script src="acm/acm-page-handler.js"></script>
	<script src="acm/acm-table.js"></script>
	<script src="acm/acm-xlsx.js"></script>
	<script src="acm/acm-file.js"></script>
	<script src="acm/acm-thumbnail.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-dropdown.js"></script>
	<script src="acm/acm-container.js"></script>
	<script src="acm/acm-img.js"></script>
	<script src="acm/acm-link.js"></script>
	<script src="acm/acm-two-col-card.js"></script>
  
</head>

<body>

  <acmus id="navbarcontainer"></acmus>
  <acmus id="pagecontainer"></acmus>

</body>

<script>

	var firstcreate = true;

	$(document).on("pagecreated",function() {
		if(firstcreate) {
			if ($.cookie("oid") && $.cookie("cid")) {
				var row = JSON.parse($.cookie("oid"));
				var row2 = JSON.parse($.cookie("cid"));
				firstcreate = false;
				if(row.type == "primer") {
					$("#primertable").transition("fade");
					$.getWidget("ordercard").fetch('lazy',[row.id]);
					//$.getWidget("ordertotal").fetch('lazy',[row.id]);
					$.getWidget("primertable").fetch('eager',[row.id]);
				} else if(row.type == "probe") {
					$("#probetable").transition("fade");
					$.getWidget("ordercard").fetch('lazy',[row.id]);
					//$.getWidget("customercard").fetch('lazy',[row2]);
					$.getWidget("probetable").fetch('eager',[row.id]);
				} else if(row.type == "sequence") {
					$("#seqtable").transition("fade");
					$.getWidget("ordercard").fetch('lazy',[row.id]);
					//$.getWidget("customercard").fetch('eager',[row2]);
					$.getWidget("seqtable").fetch('eager',[row.id]);
				}  else if(row.type == "gene") {
					$("#genetable").transition("fade");
					$.getWidget("ordercard").fetch('lazy',[row.id]);
					//$.getWidget("customercard").fetch('eager',[row2]);
					$.getWidget("genetable").fetch('eager',[row.id]);
				}
			} else {
				window.location.href = "/deliveryOrderList.html";
			}
		}
	});

	$.fn.dataTable.render.ellipsis = function ( cutoff,splice) {
		return function (data, type, row, meta) {
		
			if(data.length <= 10) return data;
		
			var shortened = data.substr(0, Number(cutoff));
			shortened += "&#8230";
			var spliced = "", offset = 0, len = data.length / Number(splice);
			for (var i = 0; i < len; i++) {
				offset = i * Number(splice);
				spliced += data.substring(offset, offset + Number(splice)) + " ";
			}
			var elm = $(document.createElement("div")).addClass("ellipsis").attr("data-content", spliced).attr("data-variation", "wide").html(shortened).hover(function (e) {
				$(e.target).popup("show");
			}).popup();
			$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(elm);
			return null;
		}
	};

  var page = {
    widgets: {
	  container: {
	  type: "container",
		selector: "#pagecontainer",
		options: {
			div: "below_navbar ui content container",
			structure: [
				{
					div: "ui grid", structure: [
						{ div: "one wide column" },
						{ div: "six wide column #ordercard" },
						{ div: "two wide column" },
						{ div: "six wide column #customercard" },
						{ div: "one wide column" }
					]
				},
				{ div: "ui divider" },
				{div : "ui header", html: "Sipariş Tablosu"},
				{ div: "transition hidden #primertable" },
				{ div: "transition hidden #probetable" },
				{ div: "transition hidden #seqtable" },
				{ div: "transition hidden #genetable" },
				/*{div: "content ui", structure: [
						{ div: "noclass #modaltable" },
						{ div: "ui divider" },
						{ div: "ui teal button #reportbutton", html: "Rapor" },
						{ div: "ui teal button #excelbutton", html: "Excel İndir" }
				]}*/
			]
		}
	  },
	  ordercard: {
		type: "twocolcard",
		selector: "#ordercard",
		options: {
			datasource: "tableService",
			fetchparams: {
				table: "orders",
				raw: true, // joined table element is not nested 
				columns: ["type", "totalcost", "date", "shipmentdate", "approval","userid"],
				join: [
					{table:"users", foreign:"userid",target:"userid", columns : ["mail","userid"]},
				],
				whereparams: ["id"]
			},
			div: "ui fluid card",
			structure: [
				{
					div: "content", structure: [
						{ div: "header", html: "Sipariş Bilgileri" }
					]
				},
				{
					div: "content", structure: [
						{ table: "ui very basic table" }
					]
				},
			],
			fields: [
				{ name: "type", html: "Ürün Türü", render: "type"},
				{ name: "date", html: "Sipariş Tarihi", type: "date", render: "momentdate" },
				{ name: "approval", html: "Onay Durumu", render: "appr" },
				{ name: "user.mail", html: "E-posta" },
				{ name: "totalcost", html: "Tutar €" },
				{ name: "shipmentdate", html: "Teslimat Tarihi" }
			]
		}
	  },
	  primertable: {
		type: "table",
		selector: "#primertable",
		options: {
			datasource:"tableService",
			fetchparams:{
				table: "primer",
				columns: ["name", "sequence", "fmod", "tmod", "purification", "scale","cost"],
				join: [
					{table:"primer_puri", foreign:"purification"},
					{table:"primer_sca", foreign:"scale"},
					{table:"primer_fifth", foreign:"fmod"},
					{table:"primer_third", foreign:"tmod"}
				],
				whereparams: ["orderid"]
			},
			table: "ui celled table",
			datatable: {
				 responsive: true,
				 dom: '<"top">rt<"bottom"p><"clear">',
				columns: [
					{ name: "name", data: "name", title: "İsim"},
					{ name: "sequence", data: "sequence", title: "Sekans" 
						,"render": "ellipsis3"
					},
					{ name: "fmod", data: "primer_fifth.val", title: "5' Modifikasyon" 
						,"render": function (data) {if (data == null) return " - "; else return data; }
					},
					{ name: "tmod", data: "primer_third.val", title: "3' Modifikasyon" 
						,"render": function (data) {if (data == null) return " - "; else return data; }
					},
					{ name: "purification", data: "primer_puri.val", title: "Purification"},
					{ name: "scale", data: "primer_sca.val", title: "Skala" },
					{ name: "cost", data: "cost", title: "Tutar" 
						,"render": function (data) {return data + " €";}
					},
				]
			}
		}
	  },
	  probetable: {
		type: "table",
		selector: "#probetable",
		options: {
			datasource:"tableService",
			fetchparams:{
				table: "probe",
				columns: ["name", "sequence", "fmod", "tmod","cost"],
				join: [
					{table:"probe_fifth", foreign:"fmod"},
					{table:"probe_third", foreign:"tmod"}
				],
				whereparams: ["orderid"]
			},
			table: "ui celled table",
			datatable: {
				 responsive: true,
				 dom: '<"top">rt<"bottom"p><"clear">',
				columns: [
					{ name: "name", data: "name", title: "İsim"},
					{ name: "sequence", data: "sequence", title: "Sekans" 
						,"render": "ellipsis3"
					},
					{ name: "fmod", data: "probe_fifth.val", title: "5' Modifikasyon" },
					{ name: "tmod", data: "probe_third.val", title: "3' Modifikasyon" },
					{ name: "cost", data: "cost", title: "Tutar" 
						,"render": function (data) {return data + " €";}
					},
				]
			}
		}
	  },
	  seqtable: {
		type: "table",
		selector: "#seqtable",
		options: {
			datasource: "tableService",
			fetchparams: {
				table: "sequence",
				columns: ["id", "name", "type", "cons", "size", "pname", "pcons", "fasta","cost"],
				filter: {
					where:{
						ordered : true
					}
				},
				whereparams: ["orderid"]
			},
			table: "ui celled table",
			datatable: {
				responsive: true,
				dom: '<"top">rt<"bottom"p><"clear">',
				columns: [{ data: "id", visible: false },
					{ name: "name", data: "name", title: "İsim" },
					{ name: "type", data: "type", title: "Tip" },
					{ name: "cons", data: "cons", title: "Konsantrasyon" },
					{ name: "size", data: "size", title: "Uzunluk" },
					{ name: "pname", data: "pname", title: "Primer" },
					{ name: "pcons", data: "pcons", title: "Prim Kons." },
					{ name: "fasta", data: "fasta", title: "Fasta" ,render: "ellipsis3"},
					{ name: "cost", data: "cost", title: "Tutar" ,render: "eur"}
				]
			}
		}
	  },
	  genetable: {
		type: "table",
		selector: "#genetable",
		options: {
			datasource: "tableService",
			fetchparams: {
				table: "gene",
				columns: ["id", "name", "sequence"],
				join: [
					{ table: "tracking", foreign: "trackingid", target: "id" },
				],
				whereparams: ["orderid"],
				order: ['gene.id ASC']
			},
			table: "ui celled table",
			datatable: {
				order: [[0, "asc"]],
				responsive: true,
				dom: '<"top">rt<"bottom"p><"clear">',
				columns: [
					{ data: "id", visible: false },
					{ name: "name", data: "name", title: "İsim" },
					{ name: "sequence", data: "sequence", title: "Sekans", render: "ellipsis3"},
					{ title: "bp", data: null, render: "getbp" },
					{ name: "cost", data: "cost", title: "Tutar", render: "eur" }
				]
			}
		}
	  }
    },
    services: {
      tableService: {
        source: "ajax",
        url: "table"
      },
	  editorService: {
		source: "ajax",
		url: "editor"
      }
    },
	functions: {
		eur: (function (data) {
			return (data == null || data == 0 ? "Fiyat İsteyiniz" : data + "<i class='icon euro sign'></i>") ;
		}).toString(),
		ellipsis: (function (data, type, row, meta) {
			if($.type(data) == "object") data = data.sequence;
			var shortened = data.substr(0, 30);
			if(shortened.length > 29) shortened += "&#8230";
			var spliced = "", offset = 0, len = data.length / 30;
			for (var i = 0; i < len; i++) {
				offset = i * 30;
				spliced += data.substring(offset, offset + 30) + " ";
			}
			var elm = $(document.createElement("div")).addClass("ellipsis").attr("data-content", spliced).attr("data-variation", "wide").html(shortened).hover(function (e) {
				$(e.target).popup("show");
			}).popup();
			$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(elm);
			return null;
		}).toString(),
		momentdate: (function(data){
			if(data == null) return "";
			moment.locale('tr');
			return moment(data).format('YYYY MM DD HH:mm');//moment(data).format('HH:mm D MMM YY');
		}).toString(),
		type: (function (data, type, row) {
			if (data == "primer") {
				return "<div><i style='color: cornflowerblue;' class='snowflake outline icon'></i>Primer</div>";
			} else if (data == "probe") {
				return "<div><i style='color: orange;' class='star icon'></i>Probe</div>";
			} else if (data == "sequence") {
				return "<div><i style='color: green;' class='dna icon'></i>Sekans</div>";
			} else if (data == "gene") {
				return "<div><i style='color: red;' class='dna icon'></i>Gen</div>";
			} else {
				return data;
			}
		}).toString(),
		ellipsis3: (function (data, type, row, meta) {
			if (!data) return "";

			var shortened = data;
			if (data.length > 10) {
				shortened = data.substr(0, Number(10));
				shortened += "&#8230";
			}

			var spliced = "", offset = 0, len = data.length / Number(3);
			for (var i = 0; i < len; i++) {
				offset = i * Number(3);
				spliced += data.substring(offset, offset + Number(3)) + " ";
			}

			var elmfull = $(document.createElement("div")).addClass("transition hidden").css("background-color", (data.includes("I") ? "#f2dede" : "ffffff")).css("margin-top", "10px").html(spliced);
			var elm = $(document.createElement("div")).html(shortened).css("background-color", (data.includes("I") ? "#f2dede" : "ffffff")).css("color", "#337ab7").on("click", function (e) {
				elmfull.transition('slide down');
			})
			$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(elm);
			$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).append(elmfull);
			return null;

		}).toString(),
		getbp: (function (data) {
			if ($.type(data) == "object") data = data.sequence;
			return data.length; //TODO calculate for multi-pair symbols
		}).toString()
	}
  };

  $.createPage(page);

</script>
<html>