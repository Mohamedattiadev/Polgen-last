<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
  <!-- Site Properties -->
  <title>Admin Müşteri Listesi</title>


  <link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
  <link rel="stylesheet" href="./semanticui/semantic.min.css">
  <link rel="stylesheet" href="./datatables/datatables.min.css">
	<link rel="stylesheet" href="./css/general.css">
   
  <script src="./jquery/jquery-3.3.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
	<script src="./semanticui/semantic.min.js"></script>
	<script src="./datatables/datatables.min.js"></script>

	<script src="./js/moment-with-locales.js"></script>
	<script src="./datatables/datetime.js"></script>
	<script src="./datatables/widgetbase.js"></script>

	<script src="./js-xlsx/xlsx.full.min.js"></script>
	<script src="./js/FileSaver.js"></script>

	<script src="acm/acm-ui-auth.js"></script>
	<script src="acm/acm-data-handler.js"></script>
	<script src="acm/acm-page-handler.js"></script>
	<script src="acm/acm-table.js"></script>
	<script src="acm/acm-xlsx.js"></script>
	<script src="acm/acm-file.js"></script>
	<script src="acm/acm-thumbnail.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-dropdown.js"></script>
	<script src="acm/acm-container.js"></script>
	<script src="acm/acm-img.js"></script>
	<script src="acm/acm-link.js"></script>
	<script src="acm/acm-two-col-card.js"></script>
	<script src="acm/acm-dialog.js"></script>
	<style>
		.ui.fullscreen.modal {
			position: static !important;
		}
	</style>
</head>

<body>

  <acmus id="navbarcontainer"></acmus>
  <acmus id="pagecontainer"></acmus>
	<acmus id="dialogcontainer"></acmus>
  
</body>

<script>

  var firstcreate = true;
  $(document).on("pagecreated",function() {
    if(firstcreate) {
		firstcreate = false;
		$.createPage(page);
		$.removeCookie("cid");
		$.removeCookie("oid");
		
		  new $.fn.dataTable.Buttons($.getWidget('customertable').table, {
			name: "export_control",
			buttons: [
			  { text: 'Excel', attr: { id: 'excel_download' } },
			  { extend: 'pdfHtml5' },
			  { extend: 'print', text: 'Yazdır' }
			]
		  });
		$.getWidget('customertable').table.DataTable().buttons(0, null).container().appendTo($('#buttoncontainer'));
	}
  

  });


  var page = {
    widgets: {
	  container: {
			type: "container",
			selector: "#pagecontainer",
			options: {
				div: "below_navbar ui content container",
				structure: [
					{div: "ui vertically divided grid", structure:[
						{div: "row",structure:[
							{div: "ui large header",structure:[
								{icon: "noclass", i:"address card outline icon"},
								{div:"content",html:"Müşteriler"}
							]}
						]},
						{div: "row",structure:[
							{div: "column", structure:[
								{div: "#customertable"}
							]}
						]},
					]}
				]
			}
	  },
      customertable: {
        type: "table",
        selector: "#customertable",
        options: {
          datasource: "editorService",
          fetchparams: {
						table: "users",
						columns: ["id","name","company","department","mail","phone","userid","couponid",
							{ col: "id", fn: "COUNT", as: "ordercount",table:"order" },
						],
						join: [
							{ table: "acm_users", foreign: "userid", columns: ["role"]},
							{ table: "orders", foreign: "userid", columns: [], target: "userid", required: false, where:{"orderdone":true}},
							{ table: "coupon", foreign: "couponid", columns: ["id","name"], addoptions: { value: "id", label: "name" }, datakey: "coupon.id"},
						],
						group: ["users.id","acm_user.id","coupon.id"],
						filter: {
							where: {
								"acm_user.role": {
									op: "eq",
									val : 1
								}
							}
						}
          },
          oncreate: true,
          table: "ui celled table",
          datatable: {
            columns: [
							{data:"id" , type: "hidden" , visible: false},
							{data:"userid",visible:false, type:"hidden"},
							{ title: "Müşteri", data: "name", render: "pagelinkcustomer"},
              { title: "Sipariş Sayısı", data: "ordercount", render:
								function(data, type, row, meta) {
									var elm = $(document.createElement("a")).addClass("item").css('cursor', 'pointer').html(data);
									elm.click(function(){
										$.cookie("cid",JSON.stringify(row.userid));
										window.location.href = "deliveryOrderList.html";
									});
									$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(elm);
									return null;
								}
							},
							{title: "Sirket", data:"company"},
							{title: "Mail" , data:"mail" },
							{title: "Kupon" , name: "coupon.id", data: "coupon.name", type:"select" ,editField: ["coupon.id"]},
							
              //{ title: "Kurum", data: "company" },
							//{ title: "Departman", data: "department" },
							//{ title: "Mail", data: "mail" },
							//{ title: "Tel.", data: "phone"}
            ],
            select: {
              style: 'os',
              className: 'active'
			},
			pageLength: 100,
            lengthChange: false,
            fixedHeader: true,
			responsive: true,
            pagingType: "full",
            language: {
              processing: "Aranıyor...",
              info: "_PAGES_ Sayfadan _PAGE_. gösteriliyor",
              infoFiltered: " - _MAX_ satırdan filtrelendi",
              infoEmpty: "0 satır bulundu",
              infoPostFix: "",
              loadingRecords: "Kayıtlar yükleniyor...",
              zeroRecords: "Kayıt bulunamadı",
              emptyTable: "Tablo boş",
              lengthMenu: "_MENU_ kayıt göster.",
              search: "_INPUT_",
              searchPlaceholder: "Arama",
              select: {
                rows: "%d satır seçildi."
              }
            }
          },
					editor: {
						allowed: ["id","coupon.name"],
						inline: {
							submit: "allIfChanged"
						},
						idSrc: "id"
					}
        }
      },
			modal: {
				type: "dialog",
				selector: "#dialogcontainer",
				options: {
					scrollfix: true,
					div: "ui fullscreen modal",
					structure: [
						{ div: "header", html: "Müşteri Bilgisi" },
						{ div: "ui divider" },
						{ div: "noclass #modalform" },
						{ div: "ui divider" },
						{
							div: "actions", structure: [
								{ div: "ui deny button", html: "Kapat" }
							]
						}
					],
					widgets: ["customercard"]
				}
			},
			modalcontainer: {
				type: "container",
				selector: "#modalform",
				options: {
					div: "noclass",
					structure: [
						{
							div: "ui grid", structure: [
								{ div: "two wide column" },
								{ div: "twelve wide column #customercard" },
								{ div: "two wide column" }
							]
						}
					]
				}
			},
			customercard: {
				type: "twocolcard",
				selector: "#customercard",
				options: {
					datasource: "tableService",
					fetchparams: {
						table: "users",
						columns: ["id", "name", "company", "department", "mail", "phone", "address"],
						whereparams: ["id"],
					},
					div: "ui fluid card",
					structure: [
						{
							div: "content", structure: [
								{ div: "header", html: "Müşteri Bilgileri" }
							]
						},
						{
							div: "content", structure: [
								{ table: "ui very basic table" }
							]
						},
					],
					fields: [
						{ name: "name", html: "Adı", def: "-" },
						{ name: "company", html: "Şirketi", def: "-" },
						{ name: "department", html: "Departman", def: "-" },
						{ name: "mail", html: "Mail Adresi", def: "-" },
						{ name: "phone", html: "Telefon", def: "-" },
						{ name: "address", html: "Adres", def: "-" }
					]
				}
			}
    },
    services: {
      tableService: {
		source: "ajax",
		url: "table"
      },
	  editorService: {
		source: "ajax",
		url: "editor"
      }
    }
  };

  




  

  // TODO: REDIRECTION ???
  /*
  $.getWidget('orderlisttable').table.on('click', 'tbody td:not(:last-child)', function () {
    window.location.replace("/adminOrderDetails.html");
  });
  */
    
</script>
<html>