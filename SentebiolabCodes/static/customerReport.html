<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
  <!-- Site Properties -->
  <title>Müşteri Raporu</title>


  <link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
  <link rel="stylesheet" href="./semanticui/semantic.min.css">
  <link rel="stylesheet" href="./datatables/datatables.min.css">
	<link rel="stylesheet" href="./css/general.css">
   
  <script src="./jquery/jquery-3.3.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
	<script src="./semanticui/semantic.min.js"></script>
	<script src="./datatables/datatables.min.js"></script>

	<script src="./js/moment-with-locales.js"></script>
	<script src="./datatables/datetime.js"></script>
	<script src="./datatables/widgetbase.js"></script>

	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	
	<script src="./js-xlsx/xlsx.full.min.js"></script>
	<script src="./js/FileSaver.js"></script>

	<script src="acm/acm-ui-auth.js"></script>
	<script src="acm/acm-data-handler.js"></script>
	<script src="acm/acm-page-handler.js"></script>
	<script src="acm/acm-table.js"></script>
	<script src="acm/acm-xlsx.js"></script>
	<script src="acm/acm-file.js"></script>
	<script src="acm/acm-thumbnail.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-dropdown.js"></script>
	<script src="acm/acm-container.js"></script>
	<script src="acm/acm-img.js"></script>
	<script src="acm/acm-link.js"></script>
	<script src="acm/acm-input.js"></script>

</head>

<body>

  <acmus id="navbarcontainer"></acmus>
  <acmus id="pagecontainer"></acmus>
  
</body>

<script>

  $(document).on("pagecreated",function() {
	$.removeCookie("cid");
	$.removeCookie("oid");
	$("#datelow").children().children().datepicker();
	$("#datehigh").children().children().datepicker();
	$("#datelow").children().children().datepicker( "option", "dateFormat", "yy-mm-dd" );
	$("#datehigh").children().children().datepicker( "option", "dateFormat", "yy-mm-dd" );
  });


  var page = {
    widgets: {
	  container: {
			type: "container",
			selector: "#pagecontainer",
			options: {
				div: "below_navbar ui content container",
				structure: [
					{div: "ui vertically divided grid", structure:[
						{div: "row",structure:[
							{div: "ui large header",structure:[
								{icon: "noclass", i:"file alternate icon"},
								{div:"content",html:"Müşteri Rapor"}
							]}
						]},
						{div: "row",structure:[
							{div:"ui input #datelow"},
							{div:"ui input #datehigh"},
							{div:"ui mini button #datebtn",html: "Ara"},
						]},
						{div: "row",structure:[
							{div: "column", structure:[
								{div: "#customertable"}
							]}
						]},
					]}
				]
			}
	  },
      customertable: {
        type: "table",
        selector: "#customertable",
        options: {
          datasource: "editorService",
          fetchparams: {
			table: "users",
			columns: ["name","company","department","mail","phone","userid",
				{ col: "id", fn: "COUNT", as: "ordercount",table:"order" }, 
				{ col: "productsnum", fn: "SUM", as: "psum",table:"order" },
				{ col: "date", fn: "MAX", as: "last",table:"order" },
			],
			join: [
				{ table: "orders", foreign: "userid", columns: [], target: "userid", required: false,
					where:{"orderdone":true, "order.date": {op: "between",val : ['1000-01-30','3000-01-30']}}
				},
				{ table: "acm_users", foreign: "userid", columns: ["role"]}, //'2019-01-19' and '2019-01-22'
			],
			group: ["users.id","acm_user.id"],
			filter: {
				where: {
					"acm_user.role": {
						op: "eq",
						val : 1
					},
				}
			}
          },
          oncreate: true,
          table: "ui celled table",

          datatable: {
            columns: [
			  {data:"userid",visible:false, type:"hidden"},
			  { title: "Kurum", data: "company" },
              { title: "Müşteri", data: "name", render:
				function(data, type, row, meta) {
					var elm = $(document.createElement("a")).addClass("item").css('cursor', 'pointer').html(data);
					elm.click(function(){
						$.cookie("cid",JSON.stringify(row.userid));
						window.location.href = "viewOrderList.html";
					});
					$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(elm);
					return null;
				}
			  },
			  { title: "Son Sipariş", data: "last",render: "momentdate" },
			  { title: "Sipariş Sayısı", data: "ordercount" },
			  { title: "Ürün Sayısı", data: "psum",render: "nullzero"},
            ],
            select: {
              style: 'os',
              className: 'active'
            },
            lengthChange: false,
            fixedHeader: true,
            responsive: true,
            pagingType: "full",
            "language": {
              processing: "Aranıyor...",
              info: "_PAGES_ Sayfadan _PAGE_. gösteriliyor",
              infoFiltered: " - _MAX_ satırdan filtrelendi",
              infoEmpty: "0 satır bulundu",
              infoPostFix: "",
              loadingRecords: "Kayıtlar yükleniyor...",
              zeroRecords: "Kayıt bulunamadı",
              emptyTable: "Tablo boş",
              lengthMenu: "_MENU_ kayıt göster.",
              search: "_INPUT_",
              searchPlaceholder: "Arama",
              select: {
                rows: "%d satır seçildi."
              }
            }
          }
        }
      },
	  datelow : {
		type: "input",
		selector: "#datelow",
		options:{
			div: "mini ui input", //div: "mini ui left labeled action input",
			type: "text",
			placeholder: "YYYY-AA-GG",
			//width: "65px"
		}
	  },
	  datehigh : {
		type: "input",
		selector: "#datehigh",
		options:{
			div: "mini ui left labeled input",
			type: "text",
			placeholder: "YYYY-AA-GG",
			//width: "65px"
		}
	  },
    },
    services: {
      tableService: {
		source: "ajax",
		url: "table"
      },
	  editorService: {
		source: "ajax",
		url: "editor"
      }
    },
	functions: {
		nullzero: (function (data, type, row) { // TODO
			if (data == null) return "0";
			else return data;
		}).toString(),
		momentdate: (function(data){
			if(data == null) return "";
			moment.locale('tr');
			return moment(data).format('YYYY-MM-DD HH:mm');//moment(data).format('HH:mm D MMM YY');
		}).toString(),
	}
  };

  $.createPage(page);

	$("#datebtn").on("click", function () {
		
		var ct = $.getWidget("customertable");
		
		if($.getWidget("datelow").get().length ) ct.options.fetchparams.join[0].where["order.date"].val[0] = $.getWidget("datelow").get();
		else ct.options.fetchparams.join[0].where["order.date"].val[0] = "1000-01-30";
		
		if($.getWidget("datehigh").get().length ) ct.options.fetchparams.join[0].where["order.date"].val[1] = $.getWidget("datehigh").get();
		else ct.options.fetchparams.join[0].where["order.date"].val[1] = "3000-01-30";
		
		ct.fetch("eager");
		
	});
	
  new $.fn.dataTable.Buttons($.getWidget('customertable').table, {
    name: "export_control",
    buttons: [
      { text: 'Excel', attr: { id: 'excel_download' } },
      { extend: 'pdfHtml5' },
      { extend: 'print', text: 'Yazdır' }
    ]
  });

  $.getWidget('customertable').table.DataTable().buttons(0, null).container().appendTo($('#buttoncontainer'));

  // TODO: REDIRECTION ???
  /*
  $.getWidget('orderlisttable').table.on('click', 'tbody td:not(:last-child)', function () {
    window.location.replace("/adminOrderDetails.html");
  });
  */
    
</script>
<html>