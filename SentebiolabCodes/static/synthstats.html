<!DOCTYPE html>
<html>

<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	<link rel="shortcut icon" type="image/png" href="assets/images/fav.png" />
  <!-- Site Properties -->
  <title>Sentez Raporu</title>


  <link rel="stylesheet" href="./jquery/jquery-plugins/css/jquery-ui.css">
  <link rel="stylesheet" href="./semanticui/semantic.min.css">
  <link rel="stylesheet" href="./datatables/datatables.min.css">
	<link rel="stylesheet" href="./css/general.css">
   
  <script src="./jquery/jquery-3.3.1.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery-ui.js"></script>
	<script src="./jquery/jquery-plugins/js/jquery.cookie-1.4.1.js"></script>
	<script src="./semanticui/semantic.min.js"></script>
	<script src="./datatables/datatables.min.js"></script>

	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	
	<script src="./js/moment-with-locales.js"></script>
	<script src="./datatables/datetime.js"></script>
	<script src="./datatables/widgetbase.js"></script>

	<script src="./js-xlsx/xlsx.full.min.js"></script>
	<script src="./js/FileSaver.js"></script>

	<script src="acm/acm-ui-auth.js"></script>
	<script src="acm/acm-data-handler.js"></script>
	<script src="acm/acm-page-handler.js"></script>
	<script src="acm/acm-table.js"></script>
	<script src="acm/acm-xlsx.js"></script>
	<script src="acm/acm-file.js"></script>
	<script src="acm/acm-thumbnail.js"></script>
	<script src="acm/acm-modal.js"></script>
	<script src="acm/acm-dropdown.js"></script>
	<script src="acm/acm-container.js"></script>
	<script src="acm/acm-img.js"></script>
	<script src="acm/acm-link.js"></script>
	<script src="acm/acm-input.js"></script>

	 <style>
		.smaller {
			font-size: smaller;
		}
		.total {
			font-weight: 1000;
		}
	</style>
	
</head>

<body>

  <acmus id="navbarcontainer"></acmus>
  <acmus id="pagecontainer"></acmus>
  <acmus id="synthtable" class="smaller"></acmus>
  
  <div class="ui grid">
	<div class="one wide column"></div>
	<div class="twelve wide column">
		<div class="ui segments">
			<div class="ui secondary segment">
				<p>Toplamlar :</p>
			</div>
			<div class="ui segment">
				<acmus id="totaltable"></acmus>
			</div>
		</div>
	</div>
  </div>
  
  
  
</body>

<script>

	var synthtype = "none";

	/*
	{div:"ui grid", structure:[
						{div:"twelve wide column",structure:[
							{div:"ui segments",structure: [
								{div:"ui secondary segment",structure: [
									{p:"noclass",html:"Primer Sipariş"}
								]},
								{div:"ui segment mainseg",structure: [
	
	*/

  $(document).on("pagecreated",function() {
	$.removeCookie("cid");
	$.removeCookie("oid");
	$("#datelow").children().children().datepicker();
	$("#datehigh").children().children().datepicker();
	$("#datelow").children().children().datepicker( "option", "dateFormat", "yy-mm-dd" );
	$("#datehigh").children().children().datepicker( "option", "dateFormat", "yy-mm-dd" );
  });

  var callbackenable = true;

  var page = {
    widgets: {
	  container: {
			type: "container",
			selector: "#pagecontainer",
			options: {
				div: "below_navbar ui content container",
				structure: [
					{div: "ui vertically divided grid", structure:[
						{div: "row",structure:[
							{div: "ui large header",structure:[
								{icon: "noclass", i:"file alternate icon"},
								{div:"content",html:"Sentez Rapor"}
							]}
						]},
						{div: "row",structure:[
							{div:"ui input #datelow"},
							{div:"ui input #datehigh"},
							{div:"ui mini blue button #searchbtn",html: "Primer"},
							{div:"ui mini green button #searchbtn2",html: "Probe"},
						]},
					]}
				]
			}
	  },
      synthtable: {
        type: "table",
        selector: "#synthtable",
        options: {
          datasource: "editorService",
          fetchparams: {
			table: "synth",
			columns: ["id","date","name","scale","pcount","bp",
				"dsltn","opcn","hplcn",
				"dsltaod","opcaod","hplcaod",
				"dsltanmol","opcanmol","hplcanmol",
				"minod","maxod","minnmol","maxnmol",
				"fill","repeat"
			],
			filter: {
				where: {
					"synth.date": {
						op: "between",
						val : ['1000-01-30','3000-01-30']
					},
					type: "type"
				}
			}
          },
          oncreate: false,
          table: "ui celled table",

          datatable: {
			dataCallback: "synthtableCallback",
			pageLength: 100,
            columns: [
			  {data:"id",name:"id",visible:false, type:"hidden"},
			  {title:"Sentez",data:"name", name:"name",render:"bolden"},
			  {title:"Skala",data:"scale", name:"scale"},
			  {title:"Ürün Sayısı",data:"pcount", name:"pcount", render: "nullzero"},
			  {title:"Toplam bp",data:"bp", name:"bp", render: "nullzero"},
			  {title:"# DSLT",data:"dsltn", name:"dsltn", render: "nullzero"},///
			  {title:"# OPC",data:"opcn", name:"opcn", render: "nullzero"},
			  {title:"# HPLC",data:"hplcn", name:"hplcn", render: "nullzero"},
			  {title:"DSLT avg OD",data:"dsltaod", name:"dsltaod", render: "fixed2"},///
			  {title:"OPC avg OD",data:"opcaod", name:"opcaod", render: "fixed2"},
			  {title:"HPLC avg OD",data:"hplcaod", name:"hplcaod", render: "fixed2"},
			  {title:"DSLT avg nmol",data:"dsltanmol", name:"dsltanmol", render: "fixed2"},///
			  {title:"OPC avg nmol",data:"opcanmol", name:"opcanmol", render: "fixed2"},
			  {title:"HPLC avg nmol",data:"hplcanmol", name:"hplcanmol", render: "fixed2"},
			  {title:"min OD",data:"minod", name:"minod", render: "fixed2"},///
			  {title:"max OD",data:"maxod", name:"maxod", render: "fixed2"},
			  {title:"min nmol",data:"minnmol", name:"minnmol", render: "fixed2"},
			  {title:"max nmol",data:"maxnmol", name:"maxnmol", render: "fixed2"},
			  {title:"Doluluk %",data:"fill", name:"fill", render: "fixed2"},///
			  {title:"Tekrar",data:"repeat", name:"repeat", render: "nullzero"},
            ],
            select: {
              style: 'os',
              className: 'active'
            },
			/*
            lengthChange: false,
            fixedHeader: true,
            responsive: true,
            pagingType: "full",
            "language": {
              processing: "Aranıyor...",
              info: "_PAGES_ Sayfadan _PAGE_. gösteriliyor",
              infoFiltered: " - _MAX_ satırdan filtrelendi",
              infoEmpty: "0 satır bulundu",
              infoPostFix: "",
              loadingRecords: "Kayıtlar yükleniyor...",
              zeroRecords: "Kayıt bulunamadı",
              emptyTable: "Tablo boş",
              lengthMenu: "_MENU_ kayıt göster.",
              search: "_INPUT_",
              searchPlaceholder: "Arama",
              select: {
                rows: "%d satır seçildi."
              }
            }*/
          }
        }
      },
	  datelow : {
		type: "input",
		selector: "#datelow",
		options:{
			div: "mini ui input", //div: "mini ui left labeled action input",
			type: "text",
			placeholder: "YYYY-AA-GG",
			//width: "65px"
		}
	  },
	  datehigh : {
		type: "input",
		selector: "#datehigh",
		options:{
			div: "mini ui left labeled input",
			type: "text",
			placeholder: "YYYY-AA-GG",
			//width: "65px"
		}
	  },
	  totaltable : {
		type: "table",
		selector: "#totaltable",
		options: {
          datasource: "editorService",
          fetchparams: {
			table: "synth",
			columns: [ "scale",
				{ col: "id", fn: "COUNT", as: "countsynth", table: "synth" },
 				{ col: "pcount", fn: "SUM", as: "sumprimer", table: "synth" },
				{ col: "bp", fn: "SUM", as: "sumbp", table: "synth" },
				{ col: "dsltn", fn: "SUM", as: "sumdslt", table: "synth" },
				{ col: "opcn", fn: "SUM", as: "sumopc", table: "synth" },
				{ col: "hplcn", fn: "SUM", as: "sumhplc", table: "synth" },
				{ col: "fill", fn: "AVG", as: "fill", table: "synth" }
			],
			group: ["synth.scale"],
			filter: {
				where: {
					"synth.date": {
						op: "between",
						val : ['1000-01-30','3000-01-30']
					},
					type: "type"
				}
			}
          },
          oncreate: false,
          table: "ui celled table",
          datatable: {
			//rowCallback: "totaltablecb",
			//footerCallback: "totaltablecb",
			dataCallback: "ttabledataCallback",
            columns: [
				{title:"Skala",data:"scale", name:"scale",render:"nmol",orderDataType: "scaleorder"},
				{title:"Sentez",data:"countsynth", name:"countsynth"},
				{title:"Primer",data:"sumprimer", name:"sumprimer"},
				{title:"bp",data:"sumbp", name:"sumbp"},
				{title:"dslt",data:"sumdslt", name:"sumdslt"},
				{title:"opc",data:"sumopc", name:"sumopc"},
				{title:"hplc",data:"sumhplc", name:"sumhplc"},
				{title:"doluluk %",data:"fill", name:"fill", render: "fixed2"}
            ],
			select: false,
			dom: '<"top"><"bottom"><"clear">',
			order: [[0, "asc"]],
			columnDefs: [
				{ type: 'num-html', targets: 0 }
			],
			/*
            lengthChange: false,
            fixedHeader: true,
            responsive: true,
            pagingType: "full",
            "language": {
              processing: "Aranıyor...",
              info: "_PAGES_ Sayfadan _PAGE_. gösteriliyor",
              infoFiltered: " - _MAX_ satırdan filtrelendi",
              infoEmpty: "0 satır bulundu",
              infoPostFix: "",
              loadingRecords: "Kayıtlar yükleniyor...",
              zeroRecords: "Kayıt bulunamadı",
              emptyTable: "Tablo boş",
              lengthMenu: "_MENU_ kayıt göster.",
              search: "_INPUT_",
              searchPlaceholder: "Arama",
              select: {
                rows: "%d satır seçildi."
              }
            }*/
          }
        }
	  }
    },
    services: {
      tableService: {
		source: "ajax",
		url: "table"
      },
	  editorService: {
		source: "ajax",
		url: "editor"
      }
    },
	functions: {
		nullzero: (function (data, type, row) { // TODO
			if (data == null) return "0";
			else return data;
		}).toString(),
		momentdate: (function(data){
			if(data == null) return "";
			moment.locale('tr');
			return moment(data).format('YYYY-MM-DD HH:mm');//moment(data).format('HH:mm D MMM YY');
		}).toString(),
		fixed2: (function (data, type, row) { // TODO
			if (data == null) return "0";
			else return Number(data).toFixed(2);
		}).toString(),
		/*totaltablecb: (function ( row, data, start, end, display) {
				
			if(callbackenable) {
				callbackenable = false;
				var api = this.api();
	 
				var td = api.column(4).data().reduce(function (a, b) {
					return Number(a) + Number(b);
				},0);
				var to = api.column(5).data().reduce(function (a, b) {
					return Number(a) + Number(b);
				},0);
				var th = api.column(6).data().reduce(function (a, b) {
					return Number(a) + Number(b);
				},0);
				
				api.rows.add([{"scale":"Toplam","countsynth":"countsynth","sumprimer":"sumprimer","sumbp":"sumbp","sumdslt":td,"sumopc":to,"sumhplc":th,"fill":0}])
				api.draw();
				
				callbackenable = true;	
			}
		}).toString(),*/
		ttabledataCallback: (function(data){
			var tempobj = {"scale":"Toplam:","countsynth":0,"sumprimer":0,"sumbp":0,"sumdslt":0,"sumopc":0,"sumhplc":0,"fill":0};
			$.each(data, function(i,v){
				tempobj.countsynth += Number(v.countsynth);
				tempobj.sumprimer += Number(v.sumprimer);
				tempobj.sumbp += Number(v.sumbp);
				tempobj.sumdslt += Number(v.sumdslt);
				tempobj.sumopc += Number(v.sumopc);
				tempobj.sumhplc += Number(v.sumhplc);
				tempobj.fill += Number(v.fill);
			});
			tempobj.fill /= data.length;
			data.push(tempobj);
		}).toString(),
		synthtableCallback: (function(data){
			var tempobj = {"id":-1,"date":"1000-01-01","name":0,"scale":"TOPLAM","pcount":0,"bp":0,"dsltn":0,"opcn":0,"hplcn":0,"dsltaod":0,"opcaod":0,"hplcaod":0,"dsltanmol":0,"opcanmol":0,"hplcanmol":0,"minod":null,"maxod":null,"minnmol":null,"maxnmol":null,"fill":0,"repeat":0};
			/*var tempobj5 = {"id":-1,"date":"1000-01-01","name":0,"scale":"TOPLAM 50","pcount":0,"bp":0,"dsltn":0,"opcn":0,"hplcn":0,"dsltaod":0,"opcaod":0,"hplcaod":0,"dsltanmol":0,"opcanmol":0,"hplcanmol":0,"minod":null,"maxod":null,"minnmol":null,"maxnmol":null,"fill":0,"repeat":0};
			var tempobj1 = {"id":-1,"date":"1000-01-01","name":0,"scale":"TOPLAM 100","pcount":0,"bp":0,"dsltn":0,"opcn":0,"hplcn":0,"dsltaod":0,"opcaod":0,"hplcaod":0,"dsltanmol":0,"opcanmol":0,"hplcanmol":0,"minod":null,"maxod":null,"minnmol":null,"maxnmol":null,"fill":0,"repeat":0};
			var tempobj2 = {"id":-1,"date":"1000-01-01","name":0,"scale":"TOPLAM 200","pcount":0,"bp":0,"dsltn":0,"opcn":0,"hplcn":0,"dsltaod":0,"opcaod":0,"hplcaod":0,"dsltanmol":0,"opcanmol":0,"hplcanmol":0,"minod":null,"maxod":null,"minnmol":null,"maxnmol":null,"fill":0,"repeat":0};
			*/
			reduceData(tempobj,data,null);
			/*reduceData(tempobj5,data,50);
			reduceData(tempobj1,data,100);
			reduceData(tempobj2,data,200);*/
			
			/*tempobj5.id = Number.MAX_SAFE_INTEGER-3;
			tempobj1.id = Number.MAX_SAFE_INTEGER-2;
			tempobj2.id = Number.MAX_SAFE_INTEGER-1;*/
			tempobj.id = Number.MAX_SAFE_INTEGER;
			
			
			data.push(tempobj);
			/*data.push(tempobj5);
			data.push(tempobj1);
			data.push(tempobj2);*/
			
		}).toString(),
		nmol: (function(data, type, row, meta){
			if (data == "Toplam:") {
				$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).parent().addClass("total");
				return data;
			}
			return data + " nmol";
		}).toString(),
		bolden: (function (data, type, row, meta) {
			if(typeof(data) != "number" && data.includes("-")) {
				
				var link = $(document.createElement("a")).addClass("tablecontent").css('cursor', 'pointer').html(data).click(function (e) {
					$.cookie("tempvarsynth", JSON.stringify({ id: row.id }));
					if (synthtype == "primer") window.location.href = "productionSynthesis.html";
					else if (synthtype == "probe") window.location.href = "productionSynthesisProbe.html";
				});
				$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).empty().append(link);

				return data;
			} else {
				$($("#" + meta.settings.sTableId).DataTable().cell(meta.row, meta.col).node()).parent().addClass("total");
				return data;
			}
		}).toString()
	}
  };

  $.createPage(page);

	$("#searchbtn").on("click", function () {
		
		var ct = $.getWidget("synthtable");
		var tt = $.getWidget("totaltable");
		
		synthtype = "primer";
		
		ct.options.fetchparams.filter.where["type"] = "primer";
		tt.options.fetchparams.filter.where["type"] = "primer";
		
		if($.getWidget("datelow").get().length ) {
			ct.options.fetchparams.filter.where["synth.date"].val[0] = $.getWidget("datelow").get();
			tt.options.fetchparams.filter.where["synth.date"].val[0] = $.getWidget("datelow").get();
		}
		else {
			ct.options.fetchparams.filter.where["synth.date"].val[0] = "1000-01-30";
			tt.options.fetchparams.filter.where["synth.date"].val[0] = "1000-01-30";
		}
		if($.getWidget("datehigh").get().length ) {
			ct.options.fetchparams.filter.where["synth.date"].val[1] = $.getWidget("datehigh").get();
			tt.options.fetchparams.filter.where["synth.date"].val[1] = $.getWidget("datehigh").get();
		}
		else {
			ct.options.fetchparams.filter.where["synth.date"].val[1] = "3000-01-30";
			tt.options.fetchparams.filter.where["synth.date"].val[1] = "3000-01-30";
		}
		
		ct.fetch("lazy");
		tt.fetch("eager")
	});
	
	$("#searchbtn2").on("click", function () {
		
		var ct = $.getWidget("synthtable");
		var tt = $.getWidget("totaltable");
		
		synthtype = "probe";
		
		ct.options.fetchparams.filter.where["type"] = "probe";
		tt.options.fetchparams.filter.where["type"] = "probe";
		
		if($.getWidget("datelow").get().length ) {
			ct.options.fetchparams.filter.where["synth.date"].val[0] = $.getWidget("datelow").get();
			tt.options.fetchparams.filter.where["synth.date"].val[0] = $.getWidget("datelow").get();
		}
		else {
			ct.options.fetchparams.filter.where["synth.date"].val[0] = "1000-01-30";
			tt.options.fetchparams.filter.where["synth.date"].val[0] = "1000-01-30";
		}
		if($.getWidget("datehigh").get().length ) {
			ct.options.fetchparams.filter.where["synth.date"].val[1] = $.getWidget("datehigh").get();
			tt.options.fetchparams.filter.where["synth.date"].val[1] = $.getWidget("datehigh").get();
		}
		else {
			ct.options.fetchparams.filter.where["synth.date"].val[1] = "3000-01-30";
			tt.options.fetchparams.filter.where["synth.date"].val[1] = "3000-01-30";
		}
		
		ct.fetch("lazy");
		tt.fetch("eager")
	});
	
	/*
	$("#probebtn").on("click", function () {
	
		var ct = $.getWidget("synthtable");
		
		if($.getWidget("datelow").get().length ) ct.options.fetchparams.filter.where["order.date"].val[0] = $.getWidget("datelow").get();
		else ct.options.fetchparams.filter.where["order.date"].val[0] = "1000-01-30";
		
		if($.getWidget("datehigh").get().length ) ct.options.fetchparams.filter.where["order.date"].val[1] = $.getWidget("datehigh").get();
		else ct.options.fetchparams.filter.where["order.date"].val[1] = "3000-01-30";
		
		ct.fetch("eager");
	
	});
	*/
  new $.fn.dataTable.Buttons($.getWidget('synthtable').table, {
    name: "export_control",
    buttons: [
      { text: 'Excel', attr: { id: 'excel_download' } },
      { extend: 'pdfHtml5' },
      { extend: 'print', text: 'Yazdır' }
    ]
  });

  $.getWidget('synthtable').table.DataTable().buttons(0, null).container().appendTo($('#buttoncontainer'));

  // TODO: REDIRECTION ???
  /*
  $.getWidget('orderlisttable').table.on('click', 'tbody td:not(:last-child)', function () {
    window.location.replace("/adminOrderDetails.html");
  });
  */
   
function reduceData(tempobj,data,targetscale) {
  
	var c = 0;
  
	$.each(data, function(i,v){
	
		if(targetscale == null || v.scale == targetscale) {
			c++;
			tempobj.name++;
			tempobj.pcount += v.pcount;
			tempobj.bp += v.bp;
			
			tempobj.dsltn += v.dsltn;
			tempobj.opcn += v.opcn;
			tempobj.hplcn += v.hplcn;
			
			tempobj.repeat += v.repeat;
			
			if(tempobj.minod === null || tempobj.minod > v.minod) tempobj.minod = v.minod;
			if(tempobj.maxod === null || tempobj.maxod < v.maxod) tempobj.maxod = v.maxod;
			if(tempobj.minnmol === null || tempobj.minnmol > v.minnmol) tempobj.minnmol = v.minnmol;
			if(tempobj.maxnmol === null || tempobj.maxnmol < v.maxnmol) tempobj.maxnmol = v.maxnmol;
			
			///AVERAGE OUT LOOP///
			tempobj.dsltaod += v.dsltaod;
			tempobj.opcaod += v.opcaod;
			tempobj.hplcaod += v.hplcaod;
			
			tempobj.dsltanmol += v.dsltanmol;
			tempobj.opcanmol += v.opcanmol;
			tempobj.hplcanmol += v.hplcanmol;
			
			tempobj.fill += v.fill;
		}
	});
	
	if (c == 0) c = 1;
	
	tempobj.dsltaod = (tempobj.dsltaod/c).toFixed(2);
	tempobj.opcaod = (tempobj.opcaod/c).toFixed(2);
	tempobj.hplcaod = (tempobj.hplcaod/c).toFixed(2);
	tempobj.dsltanmol = (tempobj.dsltanmol/c).toFixed(2);
	tempobj.opcanmol = (tempobj.opcanmol/c).toFixed(2);
	tempobj.hplcanmol = (tempobj.hplcanmol/c).toFixed(2);
	tempobj.fill = (tempobj.fill/c).toFixed(2);
}

	$.fn.dataTable.ext.order['scaleorder'] = function  ( settings, col )
	{
		return this.api().column( col, {order:'index'} ).nodes().map( function ( td, i ) {
			var x = td.innerHTML.split(" ");
			if (td.innerHTML == "50 nmol") return 0;
			if (td.innerHTML == "100 nmol") return 1;
			if (td.innerHTML == "200 nmol") return 2;
			if (td.innerHTML == "Toplam:") return 3;
			return 4;
		});
	};

</script>
<html>